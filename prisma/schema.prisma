// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GeneralData {
  id_general                 Int      @id @default(autoincrement())
  nombre_sistema             String
  direccion                  String?
  razon                      String?
  nit                        String?
  nrc                        String?
  cod_actividad              String?
  desc_actividad             String?
  nombre_comercial           String?
  contactos                  String?
  correo                     String?
  cod_estable_MH             String?
  cod_estable                String?
  cod_punto_venta_MH         String?
  cod_punto_venta            String?
  ambiente                   String?  @default("00") //00=pruebas, 01=produccion
  api_facturacion_dev        String?  @default("https://apitest.dtes.mh.gob.sv/") //00=pruebas, 01=produccion
  api_facturacion_prod       String?  @default("https://api.dtes.mh.gob.sv/") //00=pruebas, 01=produccion
  public_key                 String?  @default("")
  private_key                String?  @default("")
  api_key                    String?  @default("")
  token_api_fac              String?  @default("")
  version_email              String?  @default("1")
  token_email                String?  @default("")
  sender_email               String?  @default("")
  text_email                 String?  @default("Gracias por su preferencia!")
  domain_email               String?  @default("")
  impuesto                   Float?   @default(0.13)
  icono_sistema              String?  @default("") @db.Text
  icono_factura              String?  @default("") @db.Text
  url_facebook               String?  @default("")
  perfil_facebook            String?  @default("")
  url_instagram              String?  @default("")
  perfil_instagram           String?  @default("")
  url_pagina_web             String?  @default("")
  url_correo_atencio         String?  @default("")
  url_maps                   String?  @default("")
  whatsapp                   String?  @default("")
  color_icono                String?  @default("")

  // === CONFIGURACIÓN DE MORA POR DEFECTO ===
  id_mora_config_default Int?
  moraConfigDefault      mora_configuracion? @relation("mora_default", fields: [id_mora_config_default], references: [id_mora_config], onDelete: NoAction, onUpdate: NoAction, map: "fk_general_data_mora_default")

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model usuarios {
  id_usuario                     Int                             @id @default(autoincrement())
  usuario                        String
  password                       String
  reset_password_token           String?                         @unique
  reset_password_expires         DateTime?
  nombres                        String
  apellidos                      String
  telefono                       String                          @default("+50300000000")
  id_sucursal                    Int?
  dui                            String?
  foto                           String?                         @db.Text()
  fcm_token                      String?
  estado                         estado                          @default(ACTIVO)
  id_rol                         Int
  roles                          roles                           @relation(fields: [id_rol], references: [id_rol], onDelete: NoAction, onUpdate: NoAction, map: "fk_usuario_rol")
  id_tipo_documento              Int?
  dTETipoDocumentoIdentificacion dTETipoDocumentoIdentificacion? @relation(fields: [id_tipo_documento], references: [id_tipo_documento], onDelete: NoAction, onUpdate: NoAction, map: "fk_usuario_tipo_documento")
  log                            log[]
  fecha_creacion                 DateTime                        @default(now())
  fecha_ultima_actualizacion     DateTime                        @default(now()) @updatedAt
  Cliente                        cliente[]
  proveedores                    proveedores[]
  compras                        compras[]
  orden_trabajo                  orden_trabajo[]
  agenda_visitas                 agenda_visitas[]
  ot_historial_estado            ot_historial_estado[]
  ot_evidencias                  ot_evidencias[]
  bodegas_responsable            bodegas[]                       @relation("bodega_responsable")
  bodegas_despachador            bodegas[]                       @relation("bodega_despachador")
  importaciones_solicita         importaciones[]                 @relation("usuario_solicita_importacion")
  movimientos_inventario         movimientos_inventario[]
  reservas_inventario            reservas_inventario[]
  historial_series               historial_series[]
  retaceo_importacion            retaceo_importacion[]
  requisiciones_solicita         requisiciones_inventario[]      @relation("usuario_solicita_requisicion")
  requisiciones_autoriza         requisiciones_inventario[]      @relation("usuario_autoriza_requisicion")
  requisiciones_procesa          requisiciones_inventario[]      @relation("usuario_procesa_requisicion")
  ordenes_salida_solicita        ordenes_salida[]                @relation("usuario_solicita_orden_salida")
  ordenes_salida_autoriza        ordenes_salida[]                @relation("usuario_autoriza_orden_salida")
  ordenes_salida_procesa         ordenes_salida[]                @relation("usuario_procesa_orden_salida")
  sms_historial                  sms_historial[]
  auditorias_planifica           auditorias_inventario[]         @relation("usuario_planifica_auditoria")
  auditorias_ejecuta             auditorias_inventario[]         @relation("usuario_ejecuta_auditoria")
  auditorias_detalle_conteo      auditorias_detalle[]
  auditorias_evidencias          auditorias_evidencias[]
  ajustes_solicita               ajustes_inventario[]            @relation("usuario_solicita_ajuste")
  ajustes_autoriza               ajustes_inventario[]            @relation("usuario_autoriza_ajuste")
  snapshots_creados              snapshots_inventario[]
  metricas_calculadas            metricas_inventario[]
  usuario_permisos               usuario_permisos[]
  salidas_temporales_ot          salidas_temporales_ot[]         @relation("salida_temporal_usuario")
  contratos_creados              atcContrato[]
  dte_emitidos_creados           dte_emitidos[]                  @relation("dte_usuario_crea")
  dte_anulaciones_creadas        dte_anulaciones[]               @relation("anulacion_usuario_crea")
  // WhatsApp Chat
  whatsapp_chats_asignados       whatsapp_chat[]                 @relation("whatsapp_chat_asignado")
  whatsapp_mensajes_enviados     whatsapp_message[]              @relation("whatsapp_message_usuario")
  whatsapp_asignaciones_usuario  whatsapp_chat_assignment[]      @relation("whatsapp_assignment_usuario")
  whatsapp_asignaciones_por      whatsapp_chat_assignment[]      @relation("whatsapp_assignment_asignado_por")
}

model cliente {
  id_cliente                 Int      @id @default(autoincrement())
  id_usuario                 Int
  usuario                    usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_usuario")
  titular                    String
  fecha_nacimiento           DateTime
  dui                        String   @unique // No. Único de identidad (DUI)
  nit                        String? // No. Identificación tributaria (NIT)
  empresa_trabajo            String
  correo_electronico         String
  telefono1                  String
  telefono2                  String?
  referencia1                String
  referencia1_telefono       String
  referencia2                String
  referencia2_telefono       String
  // Nuevos campos de estado civil y vivienda
  id_estado_civil            Int?
  estado_civil               cat_estado_civil?    @relation(fields: [id_estado_civil], references: [id_estado_civil], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_estado_civil")
  id_estado_vivienda         Int?
  estado_vivienda            cat_estado_vivienda? @relation(fields: [id_estado_vivienda], references: [id_estado_vivienda], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_estado_vivienda")
  nombre_conyuge             String?
  telefono_conyuge           String?
  telefono_oficina_conyuge   String?
  estado                     estado   @default(ACTIVO)
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  direcciones       clienteDirecciones[]
  datosfacturacion  clienteDatosFacturacion[]
  documentos        clienteDocumentos[]
  ticket_soporte    ticket_soporte[]
  orden_trabajo     orden_trabajo[]
  inventario_series inventario_series[]
  sms_historial     sms_historial[]
  contratos         atcContrato[]
  dte_emitidos      dte_emitidos[]
  // WhatsApp Chat
  whatsapp_chats    whatsapp_chat[]
}

model clienteDocumentos {
  id_cliente_documento       Int      @id @default(autoincrement())
  id_cliente                 Int
  cliente                    cliente  @relation(fields: [id_cliente], references: [id_cliente], onDelete: Cascade, onUpdate: NoAction, map: "fk_cliente_documentos_cliente")
  tipo_documento             String // DUI_FRENTE, DUI_TRASERA, NIT_FRENTE, NIT_TRASERA, RECIBO
  nombre_archivo             String
  ruta_archivo               String   @db.Text
  mimetype                   String
  size                       Int
  estado                     estado   @default(ACTIVO)
  // Campos de validación IA para DUI
  validacion_ia              String?  // VALIDADO, NO_COINCIDE, NO_DETECTADO, ERROR_IA, null (no aplica)
  dui_extraido_ia            String?  // DUI extraído por IA (para auditoría)
  // Campos de validación IA para Recibo
  numero_contrato_extraido   String?  // NC extraído del recibo de servicio
  direccion_extraida         String?  // Dirección extraída del recibo
  tipo_servicio_recibo       String?  // ENERGIA, AGUA, DESCONOCIDO
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  @@index([id_cliente])
  @@index([numero_contrato_extraido])
}

model clienteDatosFacturacion {
  id_cliente_datos_facturacion   Int                             @id @default(autoincrement())
  id_cliente                     Int
  tipo                           String                          @default("PERSONA") // PERSONA o EMPRESA
  cliente                        cliente                         @relation(fields: [id_cliente], references: [id_cliente], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_datos_facturacion_cliente")
  id_tipo_documento              Int?
  dTETipoDocumentoIdentificacion dTETipoDocumentoIdentificacion? @relation(fields: [id_tipo_documento], references: [id_tipo_documento], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_datos_facturacion_tipo_documento")
  id_actividad                   Int?
  dTEActividadEconomica          dTEActividadEconomica?          @relation(fields: [id_actividad], references: [id_actividad], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_datos_facturacion_actividad_economica")
  nombre_empresa                 String
  nit                            String?
  nrc                            String?
  telefono                       String?
  correo_electronico             String?
  direccion_facturacion          String?
  id_municipio                   Int?
  municipio                      municipios?                     @relation(fields: [id_municipio], references: [id_municipio], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_datos_facturacion_municipio")
  id_departamento                Int?
  departamento                   departamentos?                  @relation(fields: [id_departamento], references: [id_departamento], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_datos_facturacion_departamento")
  estado                         estado                          @default(ACTIVO)
  fecha_creacion                 DateTime                        @default(now())
  fecha_ultima_actualizacion     DateTime                        @default(now()) @updatedAt
  dte_emitidos                   dte_emitidos[]
}

model clienteDirecciones {
  id_cliente_direccion       Int              @id @default(autoincrement())
  id_cliente                 Int
  cliente                    cliente          @relation(fields: [id_cliente], references: [id_cliente], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_direccion_cliente")
  direccion                  String
  id_colonia                 Int?
  colonias                   colonias?        @relation(fields: [id_colonia], references: [id_colonia], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_direccion_colonia")
  id_municipio               Int
  municipio                  municipios?      @relation(fields: [id_municipio], references: [id_municipio], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_direccion_municipio")
  id_departamento            Int
  departamento               departamentos?   @relation(fields: [id_departamento], references: [id_departamento], onDelete: NoAction, onUpdate: NoAction, map: "fk_cliente_direccion_departamento")
  codigo_postal              String?
  usar_para_instalacion      Boolean          @default(false)
  usar_para_facturacion      Boolean          @default(false)
  estado                     estado           @default(ACTIVO)
  fecha_creacion             DateTime         @default(now())
  fecha_ultima_actualizacion DateTime         @default(now()) @updatedAt
  ticket_soporte             ticket_soporte[]
  orden_trabajo              orden_trabajo[]
  contratos                  atcContrato[]
}

model departamentos {
  id_departamento            Int                       @id @default(autoincrement())
  nombre                     String
  codigo                     String?
  codigo_iso                 String
  estado                     estado                    @default(ACTIVO)
  Municipios                 municipios[]
  fecha_creacion             DateTime                  @default(now())
  fecha_ultima_actualizacion DateTime                  @default(now()) @updatedAt
  clienteDirecciones         clienteDirecciones[]
  clienteDatosFacturacion    clienteDatosFacturacion[]
}

model municipios {
  id_municipio               Int                       @id @default(autoincrement())
  nombre                     String
  codigo                     String?
  estado                     estado                    @default(ACTIVO)
  id_departamento            Int                       @default(0)
  Departamento               departamentos             @relation(fields: [id_departamento], references: [id_departamento], onDelete: NoAction, onUpdate: NoAction, map: "fk_municipio_departamento")
  Sucursales                 sucursales[]
  fecha_creacion             DateTime                  @default(now())
  fecha_ultima_actualizacion DateTime                  @default(now()) @updatedAt
  clienteDirecciones         clienteDirecciones[]
  colonias                   colonias[]
  clienteDatosFacturacion    clienteDatosFacturacion[]
  proveedores                proveedores[]

  @@index([id_departamento], name: "fk_municipio_departamento_id")
}

model colonias {
  id_colonia                 Int                  @id @default(autoincrement())
  nombre                     String
  codigo                     String?
  estado                     estado               @default(ACTIVO)
  id_municipio               Int                  @default(0)
  Municipio                  municipios           @relation(fields: [id_municipio], references: [id_municipio], onDelete: NoAction, onUpdate: NoAction, map: "fk_colonia_municipio")
  fecha_creacion             DateTime             @default(now())
  fecha_ultima_actualizacion DateTime             @default(now()) @updatedAt
  clienteDirecciones         clienteDirecciones[]

  @@index([id_municipio], name: "fk_colonia_municipio_id")
}

model sucursales {
  id_sucursal                Int                        @id @default(autoincrement())
  nombre                     String
  color                      String?
  complemento                String?
  telefono                   String?
  correo                     String?
  cod_estable_MH             String?                    @default("M001")
  cod_estable                String?                    @default("M001")
  cod_punto_venta_MH         String?                    @default("P001")
  cod_punto_venta            String?                    @default("P001")
  id_municipio               Int?
  Municipio                  municipios?                @relation(fields: [id_municipio], references: [id_municipio], onDelete: NoAction, onUpdate: NoAction, map: "fk_sucursal_municipio")
  id_tipo_establecimiento    Int?
  DTETipoEstablecimiento     dTETipoEstablecimiento?    @relation(fields: [id_tipo_establecimiento], references: [id_tipo_establecimiento], onDelete: NoAction, onUpdate: NoAction, map: "fk_sucursal_tipo_establecimiento")
  icono_factura              String?                    @default("") @db.Text
  estado                     estado                     @default(ACTIVO)
  facturasBloques            facturasBloques[]
  bodegas                    bodegas[]
  compras                    compras[]
  requisiciones_origen       requisiciones_inventario[] @relation("requisicion_sucursal_origen")
  requisiciones_destino      requisiciones_inventario[] @relation("requisicion_sucursal_destino")
  ordenes_salida             ordenes_salida[]
  dte_emitidos               dte_emitidos[]
  fecha_creacion             DateTime                   @default(now())
  fecha_ultima_actualizacion DateTime                   @default(now()) @updatedAt
}

model bodegas {
  id_bodega                  Int                        @id @default(autoincrement())
  nombre                     String
  descripcion                String?
  tipo                       tipo_ubicacion             @default(BODEGA) // BODEGA o CUADRILLA
  id_sucursal                Int
  sucursal                   sucursales                 @relation(fields: [id_sucursal], references: [id_sucursal])
  id_responsable             Int // usuario responsable (requerido para todas las bodegas)
  responsable                usuarios                   @relation("bodega_responsable", fields: [id_responsable], references: [id_usuario], map: "fk_bodega_responsable")
  id_despachador             Int // usuario despachador (requerido para todas las bodegas)
  despachador                usuarios                   @relation("bodega_despachador", fields: [id_despachador], references: [id_usuario], map: "fk_bodega_despachador")
  placa_vehiculo             String? // si es cuadrilla
  estado                     estado                     @default(ACTIVO)
  fecha_creacion             DateTime                   @default(now())
  fecha_ultima_actualizacion DateTime                   @default(now()) @updatedAt
  compras                    compras[]
  estantes                   estantes[]
  inventario                 inventario[]
  movimientos_origen         movimientos_inventario[]   @relation("bodega_origen")
  movimientos_destino        movimientos_inventario[]   @relation("bodega_destino")
  reservas                   reservas_inventario[]
  ot_materiales              ot_materiales[]
  requisiciones_origen       requisiciones_inventario[] @relation("requisicion_bodega_origen")
  requisiciones_destino      requisiciones_inventario[] @relation("requisicion_bodega_destino")
  ordenes_salida             ordenes_salida[]
  auditorias_inventario      auditorias_inventario[]
  ajustes_inventario         ajustes_inventario[]
  snapshots_inventario       snapshots_inventario[]
  metricas_inventario        metricas_inventario[]
  salidas_temporales_ot      salidas_temporales_ot[]    @relation("salida_temporal_bodega")
}

model estantes {
  id_estante                 Int                        @id @default(autoincrement())
  nombre                     String
  estado                     estado                     @default(ACTIVO)
  id_bodega                  Int
  bodegas                    bodegas                    @relation(fields: [id_bodega], references: [id_bodega], onDelete: NoAction, onUpdate: NoAction)
  inventario                 inventario[]
  requisiciones_origen       requisiciones_inventario[] @relation("requisicion_estante_origen")
  requisiciones_destino      requisiciones_inventario[] @relation("requisicion_estante_destino")
  ordenes_salida             ordenes_salida[]
  auditorias_inventario      auditorias_inventario[]
  ajustes_inventario         ajustes_inventario[]
  fecha_creacion             DateTime                   @default(now())
  fecha_ultima_actualizacion DateTime                   @default(now()) @updatedAt
}

model categorias {
  id_categoria               Int        @id @default(autoincrement())
  nombre                     String
  codigo                     String     @unique @db.Char(2)
  estado                     estado     @default(ACTIVO)
  catalogo                   catalogo[]
  fecha_creacion             DateTime   @default(now())
  fecha_ultima_actualizacion DateTime   @default(now()) @updatedAt

  id_categoria_padre  Int?
  categoria_padre     categorias?           @relation("Subcategorias", fields: [id_categoria_padre], references: [id_categoria], onDelete: NoAction, onUpdate: NoAction)
  sub_categorias      categorias[]          @relation("Subcategorias")
  metricas_inventario metricas_inventario[]

  @@index([id_categoria_padre])
}

model catalogo {
  id_catalogo                Int                             @id @default(autoincrement())
  id_categoria               Int
  categoria                  categorias                      @relation(fields: [id_categoria], references: [id_categoria])
  codigo                     String
  codigo_proveedor           String?
  nombre                     String
  descripcion                String?
  cantidad_minima            Int?                            @default(0) // stock mínimo
  cantidad_maxima            Int?                            @default(0) // stock máximo
  estado                     estado                          @default(ACTIVO)
  fecha_creacion             DateTime                        @default(now())
  fecha_ultima_actualizacion DateTime                        @default(now()) @updatedAt
  comprasDetalle             comprasDetalle[]
  inventario                 inventario[]
  movimientos                movimientos_inventario[]
  reservas                   reservas_inventario[]
  ot_materiales              ot_materiales[]
  importaciones_detalle      importaciones_detalle[]
  requisiciones_detalle      requisiciones_detalle[]
  ordenes_salida_detalle     ordenes_salida_detalle[]
  auditorias_detalle         auditorias_detalle[]
  ajustes_inventario         ajustes_inventario[]
  salidas_temporales_detalle salidas_temporales_ot_detalle[]
  dte_emitidos_detalle       dte_emitidos_detalle[]
}

model log {
  id                         Int       @id @default(autoincrement())
  accion                     String
  descripcion                String?
  fecha_creacion             DateTime  @default(now())
  id_usuario                 Int?
  Usuarios                   usuarios? @relation(fields: [id_usuario], references: [id_usuario])
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt
}

enum estado {
  ACTIVO
  SUPENDIDO
  INACTIVO
}

model roles {
  id_rol                     Int            @id @default(autoincrement())
  nombre                     String
  descripcion                String?        @db.Text
  estado                     estado         @default(ACTIVO)
  usuarios                   usuarios[]
  rol_permisos               rol_permisos[]
  fecha_creacion             DateTime       @default(now())
  fecha_ultima_actualizacion DateTime       @default(now()) @updatedAt
}

model facturasBloques {
  id_bloque                  Int           @id @default(autoincrement())
  tira                       String
  autorizacion               String        @default("")
  resolucion                 String?       @default("")
  desde                      Int
  hasta                      Int
  actual                     Int
  serie                      String
  id_tipo_factura            Int           @default(0)
  Tipo                       facturasTipos @relation(fields: [id_tipo_factura], references: [id_tipo_factura], onDelete: NoAction, onUpdate: NoAction, map: "fk_fatura_bloque_tipo")
  id_sucursal                Int?
  Sucursal                   sucursales?   @relation(fields: [id_sucursal], references: [id_sucursal], onDelete: NoAction, onUpdate: NoAction, map: "fk_fatura_bloque_sucursal")
  estado                     estado        @default(ACTIVO)
  fecha_creacion             DateTime      @default(now())
  fecha_ultima_actualizacion DateTime      @default(now()) @updatedAt

  @@index([id_sucursal], name: "fk_fatura_bloque_sucursal_id")
  @@index([id_tipo_factura], name: "fk_fatura_bloque_tipo_id")
}

model facturasTipos {
  id_tipo_factura            Int               @id @default(autoincrement())
  nombre                     String
  codigo                     String?
  version                    Int?
  estado                     estado            @default(ACTIVO)
  activo                     estado            @default(ACTIVO)
  Bloques                    facturasBloques[]
  fecha_creacion             DateTime          @default(now())
  fecha_ultima_actualizacion DateTime          @default(now()) @updatedAt
  compras                    compras[]
}

// catalogos de factura electronica

model dTEActividadEconomica {
  id_actividad               Int                       @id @default(autoincrement())
  nombre                     String
  codigo                     String
  estado                     estado                    @default(ACTIVO)
  fecha_creacion             DateTime                  @default(now())
  fecha_ultima_actualizacion DateTime                  @default(now()) @updatedAt
  clienteDatosFacturacion    clienteDatosFacturacion[]
  proveedores                proveedores[]
}

model dTETipoEstablecimiento {
  id_tipo_establecimiento    Int          @id @default(autoincrement())
  nombre                     String
  codigo                     String
  estado                     estado       @default(ACTIVO)
  Sucursales                 sucursales[]
  fecha_creacion             DateTime     @default(now())
  fecha_ultima_actualizacion DateTime     @default(now()) @updatedAt
}

model dTETipoInvalidacion {
  id_tipo_invalidacion       Int      @id @default(autoincrement())
  nombre                     String
  codigo                     String
  estado                     estado   @default(ACTIVO)
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETipoContingencia {
  id_tipo_contingencia       Int      @id @default(autoincrement())
  nombre                     String
  estado                     estado   @default(ACTIVO)
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETipoDocumentoIdentificacion {
  id_tipo_documento          Int                       @id @default(autoincrement())
  nombre                     String
  codigo                     String
  estado                     estado                    @default(ACTIVO)
  usuarios                   usuarios[]
  fecha_creacion             DateTime                  @default(now())
  fecha_ultima_actualizacion DateTime                  @default(now()) @updatedAt
  // cliente           Cliente[]
  // Proveedores       Proveedores[]
  clienteDatosFacturacion    clienteDatosFacturacion[]
  proveedores                proveedores[]
}

model dTERetencionIvaMh {
  id_dte_retencion_iva_mh    Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETipoGeneracionDocumento {
  id_dte_tipo_generacion_documento Int      @id @default(autoincrement())
  codigo                           Int
  valor                            String
  fecha_creacion                   DateTime @default(now())
  fecha_ultima_actualizacion       DateTime @default(now()) @updatedAt
}

model dTETipoServicioMedico {
  id_dte_tipo_servicio_medico Int      @id @default(autoincrement())
  codigo                      Int
  valor                       String
  fecha_creacion              DateTime @default(now())
  fecha_ultima_actualizacion  DateTime @default(now()) @updatedAt
}

model dTETipoItem {
  id_dte_tipo_item           Int      @id @default(autoincrement())
  codigo                     Int
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTEUnidadDeMedida {
  id_unidad_de_medida        Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETributosAplicadosPorItem {
  id_tributos_aplicados_por_item Int      @id @default(autoincrement())
  codigo                         String
  valor                          String
  fecha_creacion                 DateTime @default(now())
  fecha_ultima_actualizacion     DateTime @default(now()) @updatedAt
}

model dTETributosAplicadosPorItemCuerpo {
  id_tributos_aplicados_por_item_cuerpo Int      @id @default(autoincrement())
  codigo                                String
  valor                                 String
  fecha_creacion                        DateTime @default(now())
  fecha_ultima_actualizacion            DateTime @default(now()) @updatedAt
}

model dTEImpuestosAdValoremAplicadosPorItem {
  id_impuestos_ad_valorem_aplicados_por_item Int      @id @default(autoincrement())
  codigo                                     String
  valor                                      String
  fecha_creacion                             DateTime @default(now())
  fecha_ultima_actualizacion                 DateTime @default(now()) @updatedAt
}

model dTECondicionDeLaOperacion {
  id_condicion_de_la_operacion Int      @id @default(autoincrement())
  codigo                       Int
  valor                        String
  fecha_creacion               DateTime @default(now())
  fecha_ultima_actualizacion   DateTime @default(now()) @updatedAt
}

model dTEPlazo {
  id_plazo                   Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTEFormaPago {
  id                         Int       @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt
  compras                    compras[]
}

model dTEPais {
  id_pais                    Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
  // cliente Cliente[]
}

model dTEOtrosDocumentosAsociados {
  id_otros_documentos_asociados Int      @id @default(autoincrement())
  codigo                        Int
  valor                         String
  fecha_creacion                DateTime @default(now())
  fecha_ultima_actualizacion    DateTime @default(now()) @updatedAt
}

model dTETiposDeDocumentosEnContingencia {
  id_tipos_de_documentos_en_contingencia Int      @id @default(autoincrement())
  codigo                                 String
  valor                                  String
  fecha_creacion                         DateTime @default(now())
  fecha_ultima_actualizacion             DateTime @default(now()) @updatedAt
}

model dTETituloAQueSeRemiteLosBienes {
  id_titulo_a_que_se_remite_los_bienes Int      @id @default(autoincrement())
  codigo                               String
  valor                                String
  fecha_creacion                       DateTime @default(now())
  fecha_ultima_actualizacion           DateTime @default(now()) @updatedAt
}

model dTECategoriaDeBienYServicio {
  id_categoria               Int      @id @default(autoincrement())
  codigo                     Int
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTERecintoFiscal {
  id_recinto_fiscal          Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTERegimen {
  id_regimen                 Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETipoDePersona {
  id_tipoDePersona           Int      @id @default(autoincrement())
  codigo                     Int
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTETransporte {
  id_transporte              Int      @id @default(autoincrement())
  codigo                     Int
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTEIncoterms {
  id_incoterms               Int      @id @default(autoincrement())
  codigo                     String
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

model dTEDomicilioFiscal {
  id_domicilioFiscal         Int      @id @default(autoincrement())
  codigo                     Int
  valor                      String
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt
}

// ======================================================   Estrutura de INVENTARIO 
model proveedores {
  id_proveedor                   Int                             @id @default(autoincrement())
  nombre_razon_social            String?                         @default("")
  nombre_comercial               String?                         @default("")
  registro_nrc                   String?                         @default("")
  numero_documento               String?                         @default("")
  id_tipo_documento              Int?
  dTETipoDocumentoIdentificacion dTETipoDocumentoIdentificacion? @relation(fields: [id_tipo_documento], references: [id_tipo_documento], onDelete: NoAction, onUpdate: NoAction, map: "fk_proveedor_tipo_documento")
  id_municipio                   Int?                            @default(0)
  Municipio                      municipios?                     @relation(fields: [id_municipio], references: [id_municipio], onDelete: NoAction, onUpdate: NoAction, map: "fk_proveedor_municipio")
  direccion                      String?                         @default("")
  telefono                       String?                         @default("")
  correo                         String?                         @default("")
  dias_credito                   String?                         @default("0")
  es_internacional               Boolean                         @default(false)
  pais                           String?
  estado                         estado                          @default(ACTIVO)
  fecha_creacion                 DateTime                        @default(now())
  nombre_contac_1                String?                         @default("")
  telefono_contac_1              String?                         @default("")
  correo_contac_1                String?                         @default("")
  nombre_contac_2                String?                         @default("")
  telefono_contac_2              String?                         @default("")
  correo_contac_2                String?                         @default("")
  id_actividad_economica         Int?
  dTEActividadEconomica          dTEActividadEconomica?          @relation(fields: [id_actividad_economica], references: [id_actividad], onDelete: NoAction, onUpdate: NoAction, map: "fk_proveedor_actividad_economica")
  id_usuario                     Int
  usuario                        usuarios                        @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_proveedor_usuario")
  compras                        compras[]
  importaciones                  importaciones[]
  fecha_actualizacion            DateTime                        @default(now()) @updatedAt
}

model compras {
  id_compras          Int                      @id @default(autoincrement())
  numero_factura      String                   @default("0")
  numero_quedan       String?                  @default("0")
  detalle             String?                  @db.Text
  nombre_proveedor    String?                  @default("")
  id_proveedor        Int?
  proveedor           proveedores?             @relation(fields: [id_proveedor], references: [id_proveedor], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_proveedor")
  id_forma_pago       Int?
  dTEFormaPago        dTEFormaPago?            @relation(fields: [id_forma_pago], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_metodo_pago")
  id_usuario          Int
  usuario             usuarios                 @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_compra_usuario")
  dias_credito        Int?                     @default(0)
  subtotal            Float?                   @default(0)
  descuento           Float?                   @default(0)
  cesc                Float?                   @default(0)
  fovial              Float?                   @default(0)
  cotrans             Float?                   @default(0)
  iva                 Float?                   @default(0)
  iva_retenido        Float?                   @default(0)
  iva_percivido       Float?                   @default(0)
  total               Float?                   @default(0)
  estado              estado                   @default(ACTIVO)
  recepcionada        Boolean                  @default(false)
  fecha_recepcion     DateTime?
  id_sucursal         Int?
  sucursales          sucursales?              @relation(fields: [id_sucursal], references: [id_sucursal], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_sucursal")
  id_bodega           Int?
  bodegas             bodegas?                 @relation(fields: [id_bodega], references: [id_bodega], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_bodega")
  id_tipo_factura     Int?                     @default(2)
  facturasTipos       facturasTipos?           @relation(fields: [id_tipo_factura], references: [id_tipo_factura], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_tipo_factura")
  ComprasDetalle      comprasDetalle[]
  movimientos         movimientos_inventario[]
  fecha_creacion      DateTime                 @default(now())
  fecha_actualizacion DateTime                 @default(now())
  fecha_factura       DateTime?
  fecha_de_pago       DateTime?
  is_dte              Boolean                  @default(false)
  json_dte            String?                  @db.Text
  numeroControl       String?                  @default("")
  codigoGeneracion    String?                  @default("")

  @@index([id_tipo_factura], name: "fk_compras_tipo_factura_id")
  @@index([id_sucursal], name: "fk_compras_sucursal_id")
  @@index([id_bodega], name: "fk_compras_bodega_id")
  @@index([id_usuario], name: "fk_compra_usuario_id")
  @@index([id_proveedor], name: "fk_compras_proveedor_id")
}

model comprasDetalle {
  id_compras_detalle   Int                 @id @default(autoincrement())
  id_compras           Int
  Compras              compras             @relation(fields: [id_compras], references: [id_compras], onDelete: NoAction, onUpdate: NoAction, map: "fk_compra_detalle")
  id_catalogo          Int?
  catalogo             catalogo?           @relation(fields: [id_catalogo], references: [id_catalogo], onDelete: NoAction, onUpdate: NoAction, map: "fk_compras_detalle_catalogo")
  codigo               String?             @db.Text
  nombre               String
  descripcion          String?             @db.Text
  tiene_serie          Boolean             @default(false) // indica si el item requiere serie
  costo_unitario       Float?              @default(0)
  cantidad             Float               @default(0)
  cantidad_inventario  Float               @default(0)
  subtotal             Float?              @default(0)
  descuento_porcentaje Float?              @default(0)
  descuento_monto      Float?              @default(0)
  iva                  Float?              @default(0)
  total                Float?              @default(0)
  fecha_creacion       DateTime            @default(now())
  series               inventario_series[]

  @@index([id_compras], name: "fk_compra_detalle_id")
  @@index([id_catalogo], name: "fk_compras_detalle_catalogo_id")
}

//ORDEN DE TRABAJO MODELS
enum estado_ticket {
  ABIERTO
  EN_DIAGNOSTICO
  ESCALADO
  CERRADO
  CANCELADO
}

enum canal_contacto {
  TELEFONO
  WHATSAPP
  EMAIL
  APP
  WEB
}

enum severidad {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum estado_orden {
  PENDIENTE_ASIGNACION
  ASIGNADA
  AGENDADA
  EN_RUTA
  EN_PROGRESO
  EN_ESPERA_CLIENTE
  REPROGRAMADA
  COMPLETADA
  CANCELADA
}

enum tipo_orden {
  INCIDENCIA
  INSTALACION
  MANTENIMIENTO
  REUBICACION
  RETIRO
  MEJORA
}

enum resultado_orden {
  RESUELTO
  NO_RESUELTO
  REQUIERE_SEGUNDA_VISITA
  CLIENTE_AUSENTE
  ACCESO_DENEGADO
  FALLO_EQUIPO
}

model ticket_soporte {
  id_ticket               Int                   @id @default(autoincrement())
  id_cliente              Int
  cliente                 cliente               @relation(fields: [id_cliente], references: [id_cliente])
  canal                   canal_contacto
  descripcion_problema    String
  severidad               severidad             @default(MEDIA)
  id_direccion_servicio   Int // dirección del cliente donde ocurre el problema
  direccion_servicio      clienteDirecciones    @relation(fields: [id_direccion_servicio], references: [id_cliente_direccion])
  diagnostico_inicial     String? // texto libre del agente
  id_diagnostico_catalogo Int?
  diagnostico_catalogo    diagnostico_catalogo? @relation(fields: [id_diagnostico_catalogo], references: [id_diagnostico])
  pruebas_remotas         String? // ping, traceroute, potencia, etc.
  requiere_visita         Boolean               @default(false)
  estado                  estado_ticket         @default(ABIERTO)
  fecha_apertura          DateTime              @default(now())
  fecha_cierre            DateTime?
  cerrado_por_usuario     Int?
  observaciones_cierre    String?
  ordenes                 orden_trabajo[] // 1 ticket puede generar múltiples OT (reprogramaciones, etc.)
  sms_historial           sms_historial[]
}

model diagnostico_catalogo {
  id_diagnostico Int              @id @default(autoincrement())
  codigo         String           @unique // ej: LOS_ROJO, POTENCIA_BAJA, CPE_SIN_IP, SNR_BAJO
  nombre         String
  descripcion    String?
  activo         Boolean          @default(true)
  created_at     DateTime         @default(now())
  tickets        ticket_soporte[]
}

model solucion_catalogo {
  id_solucion    Int              @id @default(autoincrement())
  codigo         String           @unique // ej: REEMPLAZO_ONU, RECONECTOR, AJUSTE_POTENCIA, CAMBIO_PUERTO_OLT
  nombre         String
  descripcion    String?
  activo         Boolean          @default(true)
  created_at     DateTime         @default(now())
  ot_actividades ot_actividades[]
}

model motivo_cierre_catalogo {
  id_motivo  Int             @id @default(autoincrement())
  codigo     String          @unique
  nombre     String
  activo     Boolean         @default(true)
  created_at DateTime        @default(now())
  ordenes    orden_trabajo[]
}

model orden_trabajo {
  id_orden                   Int                      @id @default(autoincrement())
  codigo                     String                   @unique // OT-YYYYMM-#####
  id_ticket                  Int?
  ticket                     ticket_soporte?          @relation(fields: [id_ticket], references: [id_ticket])
  tipo                       tipo_orden
  estado                     estado_orden             @default(PENDIENTE_ASIGNACION)
  id_cliente                 Int
  cliente                    cliente                  @relation(fields: [id_cliente], references: [id_cliente])
  id_direccion_servicio      Int
  direccion_servicio         clienteDirecciones       @relation(fields: [id_direccion_servicio], references: [id_cliente_direccion])
  id_tecnico_asignado        Int?
  tecnico_asignado           usuarios?                @relation(fields: [id_tecnico_asignado], references: [id_usuario])
  ventana_programada_inicio  DateTime?
  ventana_programada_fin     DateTime?
  fecha_asignacion           DateTime?
  fecha_llegada              DateTime?
  fecha_inicio_trabajo       DateTime?
  fecha_fin_trabajo          DateTime?
  resultado                  resultado_orden?
  id_motivo_cierre           Int?
  motivo_cierre              motivo_cierre_catalogo?  @relation(fields: [id_motivo_cierre], references: [id_motivo])
  observaciones_tecnico      String?
  firma_cliente_url          String? // evidencia firma
  calificacion_cliente       Int? // 1-5
  notas_cierre               String?
  fecha_creacion             DateTime                 @default(now())
  fecha_ultima_actualizacion DateTime                 @updatedAt
  actividades                ot_actividades[]
  materiales                 ot_materiales[]
  evidencias                 ot_evidencias[]
  agendas                    agenda_visitas[]
  historico_estados          ot_historial_estado[]
  reservas                   reservas_inventario[]
  movimientos                movimientos_inventario[]
  series_asignadas           inventario_series[]
  sms_historial              sms_historial[]
  contratos                  atcContrato[]
}

model ot_historial_estado {
  id_historial Int           @id @default(autoincrement())
  id_orden     Int
  orden        orden_trabajo @relation(fields: [id_orden], references: [id_orden])
  estado       estado_orden
  comentario   String?
  cambiado_por Int // id_usuario que ejecuta el cambio
  tecnico      usuarios?     @relation(fields: [cambiado_por], references: [id_usuario])
  fecha_cambio DateTime      @default(now())
}

model ot_actividades {
  id_actividad    Int                @id @default(autoincrement())
  id_orden        Int
  orden           orden_trabajo      @relation(fields: [id_orden], references: [id_orden])
  id_solucion     Int?
  solucion        solucion_catalogo? @relation(fields: [id_solucion], references: [id_solucion])
  descripcion     String // p.ej. "Ajuste potencia en OLT", "Cambio conector SC/APC"
  valor_medido    String? // potencia dBm, SNR, latencias
  requerido_firma Boolean            @default(false)
  completado      Boolean            @default(false)
  fecha_creacion  DateTime           @default(now())
}

model ot_materiales {
  id_material           Int                @id @default(autoincrement())
  id_orden              Int
  orden                 orden_trabajo      @relation(fields: [id_orden], references: [id_orden])
  id_catalogo           Int?
  catalogo              catalogo?          @relation(fields: [id_catalogo], references: [id_catalogo])
  id_bodega_origen      Int? // de dónde se descargó
  bodega_origen         bodegas?           @relation(fields: [id_bodega_origen], references: [id_bodega])
  sku                   String?
  nombre                String?
  cantidad              Int
  id_serie              Int? // si es un item con serie
  serie                 inventario_series? @relation(fields: [id_serie], references: [id_serie])
  costo_unitario        Decimal?           @db.Decimal(10, 2)
  descargado_inventario Boolean            @default(false)
  fecha_descarga        DateTime?
  fecha_registro        DateTime           @default(now())
}

model ot_evidencias {
  id_evidencia Int           @id @default(autoincrement())
  id_orden     Int
  orden        orden_trabajo @relation(fields: [id_orden], references: [id_orden])
  tipo         String // foto_antes, foto_despues, speedtest, firma, audio
  url          String
  metadata     String? // JSON: { "ping": ..., "download": ... }
  fecha_subida DateTime      @default(now())
  subido_por   Int // id_usuario
  tecnico      usuarios?     @relation(fields: [subido_por], references: [id_usuario])
}

model agenda_visitas {
  id_agenda      Int           @id @default(autoincrement())
  id_orden       Int
  orden          orden_trabajo @relation(fields: [id_orden], references: [id_orden])
  inicio         DateTime
  fin            DateTime
  id_tecnico     Int?
  tecnico        usuarios?     @relation(fields: [id_tecnico], references: [id_usuario])
  motivo         String? // reprogramación, coordinación con cliente, lluvia, etc.
  activo         Boolean       @default(true) // solo un slot activo por OT
  creado_por     Int
  fecha_creacion DateTime      @default(now())
}

// ======================================================   Estrutura de inventario
// ============= MÓDULO DE INVENTARIO CON IMPORTACIONES =============

// Tipos de ubicación para bodegas/cuadrillas
enum tipo_ubicacion {
  BODEGA
  CUADRILLA
}

// Estados del inventario
enum estado_inventario {
  DISPONIBLE
  RESERVADO
  EN_TRANSITO
  ASIGNADO
  DEFECTUOSO
  BAJA
}

// Estados de importación
enum estado_importacion {
  COTIZACION
  ORDEN_COLOCADA
  EN_TRANSITO
  EN_ADUANA
  LIBERADA
  RECIBIDA
  CANCELADA
}

// Tipos de gasto de importación
enum tipo_gasto_importacion {
  FLETE_INTERNACIONAL
  SEGURO
  AGENTE_ADUANAL
  ALMACENAJE
  TRANSPORTE_LOCAL
  DAI // Derechos Arancelarios a la Importación
  IVA_IMPORTACION
  OTROS_IMPUESTOS
  EXTERNOS
  INTERNOS
  OTROS
}

// ============= IMPORTACIONES =============

// Orden de importación principal
model importaciones {
  id_importacion      Int                @id @default(autoincrement())
  numero_orden        String             @unique // IMP-2025-001
  id_proveedor        Int
  proveedor           proveedores        @relation(fields: [id_proveedor], references: [id_proveedor])
  id_usuario_solicita Int
  usuario_solicita    usuarios           @relation("usuario_solicita_importacion", fields: [id_usuario_solicita], references: [id_usuario])
  estado              estado_importacion @default(COTIZACION)

  // Datos de embarque
  numero_factura_proveedor String?
  numero_tracking          String?
  incoterm                 String? // FOB, CIF, EXW, etc.
  puerto_origen            String?
  puerto_destino           String?
  naviera_courier          String?

  // Fechas
  fecha_orden             DateTime  @default(now())
  fecha_embarque          DateTime?
  fecha_arribo_estimado   DateTime?
  fecha_arribo_real       DateTime?
  fecha_liberacion_aduana DateTime?
  fecha_recepcion         DateTime?

  // Montos en moneda extranjera
  moneda              String   @default("USD")
  subtotal_mercancia  Decimal  @db.Decimal(12, 2)
  flete_internacional Decimal? @default(0) @db.Decimal(12, 2)
  seguro              Decimal? @default(0) @db.Decimal(12, 2)
  total_fob           Decimal? @db.Decimal(12, 2) // subtotal + flete + seguro

  // Tipo de cambio
  tipo_cambio Decimal @db.Decimal(10, 4) // ej: 8.75 USD a moneda local

  // Totales en moneda local (después del retaceo)
  total_mercancia_local    Decimal? @db.Decimal(12, 2)
  total_gastos_importacion Decimal? @default(0) @db.Decimal(12, 2)
  total_importacion        Decimal? @db.Decimal(12, 2)

  // Aduana
  numero_declaracion String?
  agente_aduanal     String?

  observaciones String? @db.Text

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  detalle                importaciones_detalle[]
  gastos                 importaciones_gastos[]
  retaceo                retaceo_importacion[]
  movimientos_inventario movimientos_inventario[]

  @@index([estado])
  @@index([id_proveedor])
  @@index([fecha_orden])
}

// Detalle de items en la importación
model importaciones_detalle {
  id_importacion_detalle Int           @id @default(autoincrement())
  id_importacion         Int
  importacion            importaciones @relation(fields: [id_importacion], references: [id_importacion], onDelete: Cascade)

  id_catalogo Int?
  catalogo    catalogo? @relation(fields: [id_catalogo], references: [id_catalogo])

  codigo      String
  nombre      String
  descripcion String? @db.Text

  // Cantidades
  cantidad_ordenada Int
  cantidad_recibida Int @default(0)

  // Costos en moneda extranjera
  precio_unitario_usd Decimal @db.Decimal(10, 2)
  subtotal_usd        Decimal @db.Decimal(12, 2)

  // Costos en moneda local (antes del retaceo)
  precio_unitario_local Decimal? @db.Decimal(10, 2)
  subtotal_local        Decimal? @db.Decimal(12, 2)

  // Después del retaceo (costo final por unidad)
  costo_unitario_final Decimal? @db.Decimal(10, 2)
  costo_total_final    Decimal? @db.Decimal(12, 2)

  // Datos físicos para cálculo de retaceo
  peso_kg    Decimal? @db.Decimal(10, 2)
  volumen_m3 Decimal? @db.Decimal(10, 4)

  tiene_serie Boolean @default(false)

  observaciones String?

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  series          importaciones_series[]
  retaceo_detalle retaceo_detalle[]

  @@index([id_importacion])
  @@index([id_catalogo])
}

// Gastos adicionales de la importación
model importaciones_gastos {
  id_gasto       Int           @id @default(autoincrement())
  id_importacion Int
  importacion    importaciones @relation(fields: [id_importacion], references: [id_importacion], onDelete: Cascade)

  tipo        tipo_gasto_importacion
  descripcion String

  monto       Decimal  @db.Decimal(12, 2)
  moneda      String   @default("USD")
  tipo_cambio Decimal? @db.Decimal(10, 4)
  monto_local Decimal? @db.Decimal(12, 2)

  // Para retaceo
  aplica_retaceo Boolean @default(true) // si se distribuye entre items
  metodo_retaceo String? @default("VALOR") // VALOR, PESO, VOLUMEN, CANTIDAD

  numero_factura String?
  fecha_factura  DateTime?

  observaciones String?

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  retaceo retaceo_importacion[]

  @@index([id_importacion])
  @@index([tipo])
}

// Tabla de retaceo - distribución de gastos
model retaceo_importacion {
  id_retaceo     Int           @id @default(autoincrement())
  id_importacion Int
  importacion    importaciones @relation(fields: [id_importacion], references: [id_importacion])

  id_gasto Int
  gasto    importaciones_gastos @relation(fields: [id_gasto], references: [id_gasto])

  metodo_aplicado        String // VALOR, PESO, VOLUMEN, CANTIDAD
  monto_total_distribuir Decimal @db.Decimal(12, 2)

  fecha_calculo DateTime @default(now())
  calculado_por Int
  usuario       usuarios @relation(fields: [calculado_por], references: [id_usuario])

  detalle retaceo_detalle[]

  @@index([id_importacion])
  @@index([id_gasto])
}

// Detalle del retaceo por item
model retaceo_detalle {
  id_retaceo_detalle Int                 @id @default(autoincrement())
  id_retaceo         Int
  retaceo            retaceo_importacion @relation(fields: [id_retaceo], references: [id_retaceo], onDelete: Cascade)

  id_importacion_detalle Int
  detalle_importacion    importaciones_detalle @relation(fields: [id_importacion_detalle], references: [id_importacion_detalle])

  // Base de cálculo
  base_calculo        Decimal @db.Decimal(12, 4) // valor, peso, volumen o cantidad
  porcentaje_asignado Decimal @db.Decimal(8, 4) // % del gasto que le corresponde

  // Monto asignado
  monto_asignado Decimal @db.Decimal(12, 2)
  monto_unitario Decimal @db.Decimal(10, 2) // monto_asignado / cantidad

  fecha_creacion DateTime @default(now())

  @@index([id_retaceo])
  @@index([id_importacion_detalle])
}

// ============= INVENTARIO =============

// Inventario principal - control de stock por ubicación
model inventario {
  id_inventario              Int                 @id @default(autoincrement())
  id_catalogo                Int
  catalogo                   catalogo            @relation(fields: [id_catalogo], references: [id_catalogo])
  id_bodega                  Int
  bodega                     bodegas             @relation(fields: [id_bodega], references: [id_bodega])
  id_estante                 Int?
  estante                    estantes?           @relation(fields: [id_estante], references: [id_estante])
  cantidad_disponible        Int                 @default(0)
  cantidad_reservada         Int                 @default(0) // reservado para OT
  costo_promedio             Decimal?            @db.Decimal(10, 2)
  estado                     estado              @default(ACTIVO)
  fecha_creacion             DateTime            @default(now())
  fecha_ultima_actualizacion DateTime            @default(now()) @updatedAt
  series                     inventario_series[]

  @@unique([id_catalogo, id_bodega, id_estante])
  @@index([id_bodega])
  @@index([id_catalogo])
}

// Control de series para equipos (ONUs, routers, etc.)
model inventario_series {
  id_serie      Int               @id @default(autoincrement())
  id_inventario Int?
  inventario    inventario?       @relation(fields: [id_inventario], references: [id_inventario])
  numero_serie  String            @unique
  mac_address   String?
  estado        estado_inventario @default(DISPONIBLE)

  // Origen
  id_compra_detalle Int? // si vino de compra local
  compra_detalle    comprasDetalle? @relation(fields: [id_compra_detalle], references: [id_compras_detalle])

  // Asignación
  id_orden_trabajo Int? // a qué OT está asignado
  orden_trabajo    orden_trabajo? @relation(fields: [id_orden_trabajo], references: [id_orden])
  id_cliente       Int? // si está instalado en cliente
  cliente          cliente?       @relation(fields: [id_cliente], references: [id_cliente])

  // Costos
  costo_adquisicion Decimal? @db.Decimal(10, 2) // costo final con retaceo

  // Fechas
  fecha_ingreso     DateTime  @default(now())
  fecha_asignacion  DateTime?
  fecha_instalacion DateTime?
  fecha_baja        DateTime?
  motivo_baja       String?

  observaciones              String?
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  historial                    historial_series[]
  ot_materiales                ot_materiales[]
  importaciones_series         importaciones_series[]
  requisiciones_detalle_series requisiciones_detalle_series[]
  salidas_temporales_detalle   salidas_temporales_ot_detalle[] @relation("salida_temporal_serie")

  @@index([numero_serie])
  @@index([estado])
  @@index([id_inventario])
}

// Series de equipos en importación
model importaciones_series {
  id_importacion_serie   Int                   @id @default(autoincrement())
  id_importacion_detalle Int
  detalle                importaciones_detalle @relation(fields: [id_importacion_detalle], references: [id_importacion_detalle])

  numero_serie String  @unique
  mac_address  String?

  recibido        Boolean   @default(false)
  fecha_recepcion DateTime?

  id_inventario_serie Int? // vincula con inventario_series cuando se recepciona
  inventario_serie    inventario_series? @relation(fields: [id_inventario_serie], references: [id_serie])

  observaciones String?

  fecha_creacion DateTime @default(now())

  @@index([id_importacion_detalle])
  @@index([numero_serie])
}

// Historial de movimientos de series
model historial_series {
  id_historial       Int               @id @default(autoincrement())
  id_serie           Int
  serie              inventario_series @relation(fields: [id_serie], references: [id_serie])
  estado_anterior    estado_inventario
  estado_nuevo       estado_inventario
  id_bodega_anterior Int?
  id_bodega_nueva    Int?
  id_usuario         Int
  usuario            usuarios          @relation(fields: [id_usuario], references: [id_usuario])
  id_orden_trabajo   Int?
  observaciones      String?
  fecha_movimiento   DateTime          @default(now())

  @@index([id_serie])
}

// Tipos de movimiento
enum tipo_movimiento {
  ENTRADA_COMPRA
  ENTRADA_IMPORTACION
  SALIDA_OT
  TRANSFERENCIA
  AJUSTE_INVENTARIO
  DEVOLUCION
  BAJA
}

// Movimientos de inventario
model movimientos_inventario {
  id_movimiento     Int             @id @default(autoincrement())
  tipo              tipo_movimiento
  id_catalogo       Int
  catalogo          catalogo        @relation(fields: [id_catalogo], references: [id_catalogo])
  id_bodega_origen  Int?
  bodega_origen     bodegas?        @relation("bodega_origen", fields: [id_bodega_origen], references: [id_bodega])
  id_bodega_destino Int?
  bodega_destino    bodegas?        @relation("bodega_destino", fields: [id_bodega_destino], references: [id_bodega])
  cantidad          Int
  costo_unitario    Decimal?        @db.Decimal(10, 2)

  // Origen del movimiento
  id_compra        Int? // si es entrada por compra local
  compra           compras?        @relation(fields: [id_compra], references: [id_compras])
  id_importacion   Int? // si es entrada por importación
  importacion      importaciones?  @relation(fields: [id_importacion], references: [id_importacion])
  id_orden_trabajo Int? // si es salida por OT
  orden_trabajo    orden_trabajo?  @relation(fields: [id_orden_trabajo], references: [id_orden])
  id_orden_salida  Int? // si es salida por orden de salida
  orden_salida     ordenes_salida? @relation(fields: [id_orden_salida], references: [id_orden_salida])

  id_usuario       Int
  usuario          usuarios @relation(fields: [id_usuario], references: [id_usuario])
  observaciones    String?
  fecha_movimiento DateTime @default(now())

  @@index([tipo])
  @@index([id_catalogo])
  @@index([fecha_movimiento])
}

// Reservas de inventario para OT
model reservas_inventario {
  id_reserva         Int           @id @default(autoincrement())
  id_orden_trabajo   Int
  orden_trabajo      orden_trabajo @relation(fields: [id_orden_trabajo], references: [id_orden])
  id_catalogo        Int
  catalogo           catalogo      @relation(fields: [id_catalogo], references: [id_catalogo])
  id_bodega          Int
  bodega             bodegas       @relation(fields: [id_bodega], references: [id_bodega])
  cantidad_reservada Int
  cantidad_utilizada Int           @default(0)
  estado             estado        @default(ACTIVO) // ACTIVO, COMPLETADO, CANCELADO
  fecha_reserva      DateTime      @default(now())
  fecha_vencimiento  DateTime? // si la reserva expira
  fecha_completado   DateTime?
  id_usuario         Int
  usuario            usuarios      @relation(fields: [id_usuario], references: [id_usuario])

  @@index([id_orden_trabajo])
  @@index([estado])
}

// ============= ACTUALIZACIONES A TABLAS EXISTENTES =============

// ============= MÓDULO DE REQUISICIONES =============

// Estados de requisición
enum estado_requisicion {
  PENDIENTE
  APROBADA
  RECHAZADA
  PROCESADA
  CANCELADA
}

// Tipos de requisición
enum tipo_requisicion {
  TRANSFERENCIA_BODEGA
  TRANSFERENCIA_SUCURSAL
  CAMBIO_ESTANTE
}

// Requisiciones de inventario
model requisiciones_inventario {
  id_requisicion Int                @id @default(autoincrement())
  codigo         String             @unique // REQ-YYYYMM-#####
  tipo           tipo_requisicion
  estado         estado_requisicion @default(PENDIENTE)

  // Origen
  id_sucursal_origen Int?
  sucursal_origen    sucursales? @relation("requisicion_sucursal_origen", fields: [id_sucursal_origen], references: [id_sucursal])
  id_bodega_origen   Int?
  bodega_origen      bodegas?    @relation("requisicion_bodega_origen", fields: [id_bodega_origen], references: [id_bodega])
  id_estante_origen  Int?
  estante_origen     estantes?   @relation("requisicion_estante_origen", fields: [id_estante_origen], references: [id_estante])

  // Destino
  id_sucursal_destino Int?
  sucursal_destino    sucursales? @relation("requisicion_sucursal_destino", fields: [id_sucursal_destino], references: [id_sucursal])
  id_bodega_destino   Int?
  bodega_destino      bodegas?    @relation("requisicion_bodega_destino", fields: [id_bodega_destino], references: [id_bodega])
  id_estante_destino  Int?
  estante_destino     estantes?   @relation("requisicion_estante_destino", fields: [id_estante_destino], references: [id_estante])

  // Usuarios
  id_usuario_solicita Int
  usuario_solicita    usuarios  @relation("usuario_solicita_requisicion", fields: [id_usuario_solicita], references: [id_usuario])
  id_usuario_autoriza Int?
  usuario_autoriza    usuarios? @relation("usuario_autoriza_requisicion", fields: [id_usuario_autoriza], references: [id_usuario])
  id_usuario_procesa  Int?
  usuario_procesa     usuarios? @relation("usuario_procesa_requisicion", fields: [id_usuario_procesa], references: [id_usuario])

  // Observaciones
  motivo                     String? @db.Text
  observaciones_autorizacion String? @db.Text
  observaciones_proceso      String? @db.Text

  // Fechas
  fecha_solicitud            DateTime  @default(now())
  fecha_autorizacion         DateTime?
  fecha_proceso              DateTime?
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  // Relaciones
  detalle requisiciones_detalle[]

  @@index([estado])
  @@index([tipo])
  @@index([id_usuario_solicita])
  @@index([fecha_solicitud])
}

// Detalle de requisiciones
model requisiciones_detalle {
  id_requisicion_detalle Int                      @id @default(autoincrement())
  id_requisicion         Int
  requisicion            requisiciones_inventario @relation(fields: [id_requisicion], references: [id_requisicion], onDelete: Cascade)

  id_catalogo Int
  catalogo    catalogo @relation(fields: [id_catalogo], references: [id_catalogo])

  cantidad_solicitada Int
  cantidad_autorizada Int?
  cantidad_procesada  Int  @default(0)

  observaciones String?

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relación con series (para productos serializados)
  series requisiciones_detalle_series[]

  @@index([id_requisicion])
  @@index([id_catalogo])
}

// Series específicas incluidas en requisiciones (para productos serializados)
model requisiciones_detalle_series {
  id_requisicion_detalle_serie Int                   @id @default(autoincrement())
  id_requisicion_detalle       Int
  requisicion_detalle          requisiciones_detalle @relation(fields: [id_requisicion_detalle], references: [id_requisicion_detalle], onDelete: Cascade)

  id_serie Int
  serie    inventario_series @relation(fields: [id_serie], references: [id_serie])

  fecha_creacion DateTime @default(now())

  @@unique([id_requisicion_detalle, id_serie])
  @@index([id_requisicion_detalle])
  @@index([id_serie])
}

// ============= MÓDULO DE ÓRDENES DE SALIDA =============

// Estados de orden de salida
enum estado_orden_salida {
  BORRADOR
  PENDIENTE_AUTORIZACION
  AUTORIZADA
  RECHAZADA
  PROCESADA
  CANCELADA
}

// Tipos de orden de salida
enum tipo_orden_salida {
  VENTA
  DONACION
  BAJA_INVENTARIO
  DEVOLUCION_PROVEEDOR
  TRASLADO_EXTERNO
  CONSUMO_INTERNO
  MERMA
  OTRO
}

// Órdenes de salida de inventario
model ordenes_salida {
  id_orden_salida Int                 @id @default(autoincrement())
  codigo          String              @unique // OS-YYYYMM-#####
  tipo            tipo_orden_salida
  estado          estado_orden_salida @default(BORRADOR)

  // Origen de la salida
  id_sucursal_origen Int
  sucursal_origen    sucursales @relation(fields: [id_sucursal_origen], references: [id_sucursal])
  id_bodega_origen   Int
  bodega_origen      bodegas    @relation(fields: [id_bodega_origen], references: [id_bodega])
  id_estante         Int?
  estante            estantes?  @relation(fields: [id_estante], references: [id_estante])

  // Usuarios involucrados
  id_usuario_solicita Int
  usuario_solicita    usuarios  @relation("usuario_solicita_orden_salida", fields: [id_usuario_solicita], references: [id_usuario])
  id_usuario_autoriza Int?
  usuario_autoriza    usuarios? @relation("usuario_autoriza_orden_salida", fields: [id_usuario_autoriza], references: [id_usuario])
  id_usuario_procesa  Int?
  usuario_procesa     usuarios? @relation("usuario_procesa_orden_salida", fields: [id_usuario_procesa], references: [id_usuario])

  // Observaciones y motivos
  motivo                     String? @db.Text
  observaciones_autorizacion String? @db.Text
  observaciones_proceso      String? @db.Text
  motivo_rechazo             String? @db.Text

  // Totales
  subtotal Decimal? @default(0) @db.Decimal(12, 2)
  total    Decimal? @default(0) @db.Decimal(12, 2)

  // Fechas
  fecha_solicitud            DateTime  @default(now())
  fecha_autorizacion         DateTime?
  fecha_proceso              DateTime?
  fecha_salida_efectiva      DateTime? // Fecha real de salida física
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  // Relaciones
  detalle     ordenes_salida_detalle[]
  movimientos movimientos_inventario[]

  @@index([estado])
  @@index([tipo])
  @@index([id_bodega_origen])
  @@index([id_usuario_solicita])
  @@index([fecha_solicitud])
}

// Detalle de órdenes de salida
model ordenes_salida_detalle {
  id_orden_salida_detalle Int            @id @default(autoincrement())
  id_orden_salida         Int
  orden_salida            ordenes_salida @relation(fields: [id_orden_salida], references: [id_orden_salida], onDelete: Cascade)

  id_catalogo Int
  catalogo    catalogo @relation(fields: [id_catalogo], references: [id_catalogo])

  cantidad_solicitada Int
  cantidad_autorizada Int?
  cantidad_procesada  Int  @default(0)

  costo_unitario Decimal? @db.Decimal(10, 2)
  subtotal       Decimal? @db.Decimal(12, 2)

  observaciones String?

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  @@index([id_orden_salida])
  @@index([id_catalogo])
}

// Enum para tipos de mensajes SMS
enum tipo_mensaje_sms {
  NOTIFICACION_FACTURA
  TECNICO_EN_CAMINO
  ORDEN_TRABAJO_ASIGNADA
  ORDEN_TRABAJO_AGENDADA
  ORDEN_TRABAJO_COMPLETADA
  TICKET_CREADO
  TICKET_ACTUALIZADO
  CAMBIO_ESTADO_SERVICIO
  RECORDATORIO_PAGO
  PROMOCION
  GENERAL
}

// Enum para estados de envío de SMS
enum estado_envio_sms {
  PENDIENTE
  ENVIADO
  ENTREGADO
  FALLIDO
  EN_COLA
}

// ============= ENUMS PARA AUDITORÍAS DE INVENTARIO =============

enum tipo_auditoria {
  COMPLETA
  SORPRESA
}

enum estado_auditoria {
  PLANIFICADA
  EN_PROGRESO
  PENDIENTE_REVISION
  COMPLETADA
  CANCELADA
}

enum tipo_discrepancia {
  FALTANTE
  SOBRANTE
  CONFORME
}

enum causa_discrepancia {
  ROBO
  MERMA
  ERROR_REGISTRO
  ERROR_CONTEO
  DANO
  OTRO
  PENDIENTE_INVESTIGACION
}

enum estado_ajuste {
  PENDIENTE_AUTORIZACION
  AUTORIZADO
  RECHAZADO
  APLICADO
  CANCELADO
}

enum tipo_snapshot {
  AUDITORIA
  MENSUAL
  TRIMESTRAL
  ANUAL
  MANUAL
}

// Tabla de historial de SMS enviados
model sms_historial {
  id_sms Int @id @default(autoincrement())

  // Destinatario
  telefono_destino String // Número en formato +503XXXXXXXX
  id_cliente       Int?
  cliente          cliente? @relation(fields: [id_cliente], references: [id_cliente])

  // Contenido
  tipo_mensaje tipo_mensaje_sms
  mensaje      String           @db.Text

  // Referencias (opcionales según el tipo de mensaje)
  id_orden_trabajo     Int?
  orden_trabajo        orden_trabajo?  @relation(fields: [id_orden_trabajo], references: [id_orden])
  id_ticket            Int?
  ticket               ticket_soporte? @relation(fields: [id_ticket], references: [id_ticket])
  referencia_adicional String? // Para facturas, etc.

  // Estado de envío
  estado estado_envio_sms @default(PENDIENTE)

  // Información de Twilio
  twilio_sid           String? @unique // Message SID de Twilio
  twilio_status        String? // Status devuelto por Twilio
  twilio_error_code    String?
  twilio_error_message String?

  // Costos
  costo  Decimal? @db.Decimal(10, 4)
  moneda String?  @default("USD")

  // Metadata
  enviado_por          Int? // Usuario que solicitó el envío
  usuario              usuarios? @relation(fields: [enviado_por], references: [id_usuario])
  intentos_envio       Int       @default(1)
  fecha_ultimo_intento DateTime?

  // Timestamps
  fecha_creacion             DateTime  @default(now())
  fecha_envio                DateTime?
  fecha_entrega              DateTime?
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  @@index([telefono_destino])
  @@index([estado])
  @@index([tipo_mensaje])
  @@index([id_cliente])
  @@index([id_orden_trabajo])
  @@index([id_ticket])
  @@index([fecha_creacion])
}

// ============= MÓDULO DE AUDITORÍAS DE INVENTARIO =============

// Auditorías de inventario (cabecera)
model auditorias_inventario {
  id_auditoria Int              @id @default(autoincrement())
  codigo       String           @unique // AUD-YYYYMM-####
  tipo         tipo_auditoria
  estado       estado_auditoria @default(PLANIFICADA)

  // Alcance de la auditoría
  id_bodega  Int
  bodega     bodegas   @relation(fields: [id_bodega], references: [id_bodega])
  id_estante Int?
  estante    estantes? @relation(fields: [id_estante], references: [id_estante])

  // Auditar todo o solo categorías específicas
  incluir_todas_categorias Boolean @default(true)
  categorias_a_auditar     String? @db.Text // JSON array de IDs de categorías

  // Usuarios involucrados
  id_usuario_planifica Int
  usuario_planifica    usuarios  @relation("usuario_planifica_auditoria", fields: [id_usuario_planifica], references: [id_usuario])
  id_usuario_ejecuta   Int?
  usuario_ejecuta      usuarios? @relation("usuario_ejecuta_auditoria", fields: [id_usuario_ejecuta], references: [id_usuario])

  // Fechas
  fecha_planificada DateTime?
  fecha_inicio      DateTime?
  fecha_fin         DateTime?

  // Resumen de resultados (calculado al finalizar)
  total_items_auditados        Int      @default(0)
  total_items_conformes        Int      @default(0)
  total_items_con_discrepancia Int      @default(0)
  valor_total_discrepancias    Decimal? @db.Decimal(12, 2)
  porcentaje_accuracy          Decimal? @db.Decimal(5, 2) // % de items conformes

  observaciones              String?  @db.Text
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  detalle    auditorias_detalle[]
  evidencias auditorias_evidencias[]
  ajustes    ajustes_inventario[]
  snapshot   snapshots_inventario?

  @@index([estado])
  @@index([tipo])
  @@index([id_bodega])
  @@index([fecha_planificada])
  @@index([fecha_creacion])
}

// Detalle de auditorías por producto
model auditorias_detalle {
  id_auditoria_detalle Int                   @id @default(autoincrement())
  id_auditoria         Int
  auditoria            auditorias_inventario @relation(fields: [id_auditoria], references: [id_auditoria], onDelete: Cascade)

  id_catalogo Int
  catalogo    catalogo @relation(fields: [id_catalogo], references: [id_catalogo])

  // Datos del sistema (al momento del conteo)
  cantidad_sistema           Int // Stock según sistema
  cantidad_reservada_sistema Int     @default(0)
  costo_promedio_sistema     Decimal @db.Decimal(10, 2)

  // Datos del conteo físico
  cantidad_fisica Int? // Conteo físico real
  fue_contado     Boolean @default(false)

  // Discrepancia
  discrepancia            Int? // física - sistema
  discrepancia_valor      Decimal?           @db.Decimal(12, 2) // discrepancia * costo
  porcentaje_discrepancia Decimal?           @db.Decimal(5, 2)
  tipo_discrepancia       tipo_discrepancia?

  // Análisis
  causa_probable         causa_discrepancia? @default(PENDIENTE_INVESTIGACION)
  requiere_investigacion Boolean             @default(false)
  observaciones_conteo   String?             @db.Text

  // Metadata
  id_usuario_conteo Int?
  usuario_conteo    usuarios? @relation(fields: [id_usuario_conteo], references: [id_usuario])
  fecha_conteo      DateTime?

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  series auditorias_series[]

  @@unique([id_auditoria, id_catalogo])
  @@index([id_auditoria])
  @@index([id_catalogo])
  @@index([tipo_discrepancia])
}

// Series escaneadas durante auditoría (para productos serializados)
model auditorias_series {
  id_auditoria_serie   Int                @id @default(autoincrement())
  id_auditoria_detalle Int
  detalle              auditorias_detalle @relation(fields: [id_auditoria_detalle], references: [id_auditoria_detalle], onDelete: Cascade)

  numero_serie           String
  encontrado_fisicamente Boolean @default(true)

  // Validación contra sistema
  existe_en_sistema         Boolean            @default(false)
  estado_en_sistema         estado_inventario?
  ubicacion_esperada_bodega Int?
  ubicacion_real_bodega     Int?

  observaciones String?
  fecha_escaneo DateTime @default(now())

  @@index([id_auditoria_detalle])
  @@index([numero_serie])
}

// Evidencias fotográficas de auditorías
model auditorias_evidencias {
  id_evidencia Int                   @id @default(autoincrement())
  id_auditoria Int
  auditoria    auditorias_inventario @relation(fields: [id_auditoria], references: [id_auditoria], onDelete: Cascade)

  tipo        String // ESTANTE, PRODUCTO, GENERAL, DISCREPANCIA
  titulo      String?
  descripcion String? @db.Text

  // Archivo
  nombre_archivo String
  ruta_archivo   String @db.Text // Ruta en MinIO
  mimetype       String
  size           Int

  // Referencia opcional a producto específico
  id_catalogo Int?

  id_usuario_subida Int
  usuario_subida    usuarios @relation(fields: [id_usuario_subida], references: [id_usuario])
  fecha_subida      DateTime @default(now())

  @@index([id_auditoria])
  @@index([id_catalogo])
}

// Ajustes de inventario post-auditoría
model ajustes_inventario {
  id_ajuste Int    @id @default(autoincrement())
  codigo    String @unique // AJU-YYYYMM-####

  // Vinculado a auditoría
  id_auditoria         Int?
  auditoria            auditorias_inventario? @relation(fields: [id_auditoria], references: [id_auditoria])
  id_auditoria_detalle Int?

  // Ubicación del ajuste
  id_catalogo Int
  catalogo    catalogo  @relation(fields: [id_catalogo], references: [id_catalogo])
  id_bodega   Int
  bodega      bodegas   @relation(fields: [id_bodega], references: [id_bodega])
  id_estante  Int?
  estante     estantes? @relation(fields: [id_estante], references: [id_estante])

  // Cantidades
  cantidad_anterior Int
  cantidad_ajuste   Int // + para aumentar, - para reducir
  cantidad_nueva    Int
  costo_unitario    Decimal? @db.Decimal(10, 2)

  // Motivo
  motivo             tipo_movimiento     @default(AJUSTE_INVENTARIO)
  motivo_detallado   String              @db.Text
  tipo_discrepancia  tipo_discrepancia?
  causa_discrepancia causa_discrepancia?

  // Workflow de autorización
  estado                     estado_ajuste @default(PENDIENTE_AUTORIZACION)
  id_usuario_solicita        Int
  usuario_solicita           usuarios      @relation("usuario_solicita_ajuste", fields: [id_usuario_solicita], references: [id_usuario])
  id_usuario_autoriza        Int?
  usuario_autoriza           usuarios?     @relation("usuario_autoriza_ajuste", fields: [id_usuario_autoriza], references: [id_usuario])
  observaciones_autorizacion String?       @db.Text
  motivo_rechazo             String?       @db.Text

  // Fechas
  fecha_solicitud    DateTime  @default(now())
  fecha_autorizacion DateTime?
  fecha_aplicacion   DateTime?

  // Vinculación a movimiento generado
  id_movimiento_generado Int?

  // Documentos soporte
  documentos_soporte String? @db.Text // JSON array de URLs

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  @@index([estado])
  @@index([id_auditoria])
  @@index([id_catalogo])
  @@index([id_bodega])
  @@index([fecha_solicitud])
}

// Snapshots de inventario (fotografías del estado)
model snapshots_inventario {
  id_snapshot Int    @id @default(autoincrement())
  codigo      String @unique // SNP-YYYYMM-####

  tipo        tipo_snapshot
  periodo     String? // "2025-01" para mensuales
  descripcion String?

  // Vinculado a auditoría si aplica
  id_auditoria Int?                   @unique
  auditoria    auditorias_inventario? @relation(fields: [id_auditoria], references: [id_auditoria])

  // Alcance
  id_bodega Int?
  bodega    bodegas? @relation(fields: [id_bodega], references: [id_bodega])

  // Resumen general
  total_items            Int      @default(0)
  total_cantidad         Int      @default(0)
  valor_total_inventario Decimal? @db.Decimal(14, 2)

  fecha_snapshot  DateTime @default(now())
  creado_por      Int
  usuario_creador usuarios @relation(fields: [creado_por], references: [id_usuario])

  fecha_creacion DateTime @default(now())

  // Relaciones
  detalle snapshots_detalle[]

  @@index([tipo])
  @@index([periodo])
  @@index([id_bodega])
  @@index([fecha_snapshot])
}

// Detalle de snapshots por producto
model snapshots_detalle {
  id_snapshot_detalle Int                  @id @default(autoincrement())
  id_snapshot         Int
  snapshot            snapshots_inventario @relation(fields: [id_snapshot], references: [id_snapshot], onDelete: Cascade)

  id_catalogo Int
  id_bodega   Int
  id_estante  Int?

  cantidad_disponible Int
  cantidad_reservada  Int
  cantidad_total      Int // disponible + reservada
  costo_promedio      Decimal @db.Decimal(10, 2)
  valor_total         Decimal @db.Decimal(12, 2)

  fecha_creacion DateTime @default(now())

  @@index([id_snapshot])
  @@index([id_catalogo])
  @@index([id_bodega])
}

// Métricas agregadas de inventario
model metricas_inventario {
  id_metrica Int @id @default(autoincrement())

  periodo      String // "2025-01"
  tipo_periodo String @default("MENSUAL") // MENSUAL, TRIMESTRAL, ANUAL

  // Alcance
  id_bodega    Int?
  bodega       bodegas?    @relation(fields: [id_bodega], references: [id_bodega])
  id_categoria Int?
  categoria    categorias? @relation(fields: [id_categoria], references: [id_categoria])

  // Métricas de auditorías
  total_auditorias_realizadas  Int      @default(0)
  total_items_auditados        Int      @default(0)
  total_items_conformes        Int      @default(0)
  total_items_con_discrepancia Int      @default(0)
  accuracy_porcentaje          Decimal? @db.Decimal(5, 2)

  // Métricas de valor
  valor_total_inventario        Decimal? @db.Decimal(14, 2)
  valor_discrepancias_positivas Decimal? @db.Decimal(12, 2) // sobrantes
  valor_discrepancias_negativas Decimal? @db.Decimal(12, 2) // faltantes
  valor_neto_discrepancias      Decimal? @db.Decimal(12, 2)

  // Métricas de movimientos
  total_movimientos         Int @default(0)
  total_ajustes             Int @default(0)
  total_ajustes_autorizados Int @default(0)

  fecha_calculo   DateTime  @default(now())
  calculado_por   Int?
  usuario_calculo usuarios? @relation(fields: [calculado_por], references: [id_usuario])

  @@unique([periodo, id_bodega, id_categoria])
  @@index([periodo])
  @@index([id_bodega])
  @@index([id_categoria])
}

// ============= MÓDULO DE PERMISOS Y POLÍTICAS DE AUTORIZACIÓN =============

// Enums para sistema de permisos
enum tipo_permiso {
  RECURSO // Permiso a nivel de recurso:acción (ej: inventario.compras:crear)
  FUNCIONAL // Permiso funcional simple (ej: ver_dashboard)
}

enum tipo_accion {
  VER
  CREAR
  EDITAR
  ELIMINAR
  APROBAR
  RECHAZAR
  EXPORTAR
  IMPRIMIR
  CUSTOM // Para acciones personalizadas
}

enum tipo_politica {
  SUCURSAL // Validar que pertenezca a la misma sucursal
  PROPIETARIO // Validar que sea el propietario del recurso
  ESTADO_RECURSO // Validar estado del recurso (ej: ticket no cerrado)
  CUSTOM // Política personalizada con lógica compleja
}

// Tabla principal de permisos del sistema
model permisos {
  id_permiso  Int     @id @default(autoincrement())
  codigo      String  @unique // Ej: "inventario.compras:crear"
  nombre      String // Nombre descriptivo: "Crear órdenes de compra"
  descripcion String? @db.Text

  // Estructura del permiso
  modulo  String // Módulo al que pertenece: "inventario", "ventas", etc.
  recurso String // Recurso específico: "compras", "clientes", "usuarios"
  accion  tipo_accion // Acción permitida: VER, CREAR, EDITAR, etc.

  tipo   tipo_permiso @default(RECURSO)
  estado estado       @default(ACTIVO)

  // Metadata
  es_critico         Boolean @default(false) // Si es permiso crítico (ej: eliminar usuarios)
  requiere_auditoria Boolean @default(false) // Si acciones con este permiso se auditan

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  rol_permisos      rol_permisos[]
  usuario_permisos  usuario_permisos[]
  permiso_politicas permiso_politicas[]

  @@index([modulo])
  @@index([recurso])
  @@index([accion])
  @@index([estado])
}

// Relación muchos-a-muchos: Roles ↔ Permisos
model rol_permisos {
  id_rol_permiso Int @id @default(autoincrement())
  id_rol         Int
  id_permiso     Int

  roles    roles    @relation(fields: [id_rol], references: [id_rol], onDelete: Cascade)
  permisos permisos @relation(fields: [id_permiso], references: [id_permiso], onDelete: Cascade)

  fecha_creacion DateTime @default(now())

  @@unique([id_rol, id_permiso])
  @@index([id_rol])
  @@index([id_permiso])
}

// Permisos adicionales asignados individualmente a usuarios
model usuario_permisos {
  id_usuario_permiso Int @id @default(autoincrement())
  id_usuario         Int
  id_permiso         Int

  usuarios usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  permisos permisos @relation(fields: [id_permiso], references: [id_permiso], onDelete: Cascade)

  // Metadata
  asignado_por     Int? // Usuario que asignó este permiso
  motivo           String?   @db.Text // Justificación de por qué se asignó
  fecha_expiracion DateTime? // Si el permiso tiene fecha de expiración

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  @@unique([id_usuario, id_permiso])
  @@index([id_usuario])
  @@index([id_permiso])
  @@index([fecha_expiracion])
}

// Políticas de autorización (reglas condicionales)
model politicas {
  id_politica Int     @id @default(autoincrement())
  codigo      String  @unique // Ej: "same_sucursal", "is_owner"
  nombre      String // Nombre descriptivo
  descripcion String? @db.Text

  tipo tipo_politica

  // Configuración de la política (JSON flexible)
  configuracion Json? // Configuración específica de cada política

  // Handler de la política (nombre de la función/clase que la valida)
  handler String // Ej: "SameSucursalPolicy", "IsOwnerPolicy"

  estado estado @default(ACTIVO)

  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  permiso_politicas permiso_politicas[]

  @@index([tipo])
  @@index([estado])
}

// Relación muchos-a-muchos: Permisos ↔ Políticas
model permiso_politicas {
  id_permiso_politica Int @id @default(autoincrement())
  id_permiso          Int
  id_politica         Int

  permisos  permisos  @relation(fields: [id_permiso], references: [id_permiso], onDelete: Cascade)
  politicas politicas @relation(fields: [id_politica], references: [id_politica], onDelete: Cascade)

  // Si la política es obligatoria para este permiso
  es_obligatoria Boolean @default(true)

  fecha_creacion DateTime @default(now())

  @@unique([id_permiso, id_politica])
  @@index([id_permiso])
  @@index([id_politica])
}

// ============= MÓDULO DE SALIDAS TEMPORALES DE OT (TEMPORAL) =============

// Estados de salida temporal
enum estado_salida_temporal {
  PROCESADA
  CANCELADA
}

// Salidas temporales de inventario para OT
model salidas_temporales_ot {
  id_salida_temporal Int    @id @default(autoincrement())
  codigo             String @unique // Código de OT alfanumérico ingresado por el usuario (ej: OT-202501-00001 o cualquier formato)

  // Origen (bodega del usuario responsable, auto-asignada)
  id_bodega_origen Int
  bodega_origen    bodegas @relation("salida_temporal_bodega", fields: [id_bodega_origen], references: [id_bodega])

  // Usuario que crea la salida
  id_usuario_crea Int
  usuario_crea    usuarios @relation("salida_temporal_usuario", fields: [id_usuario_crea], references: [id_usuario])

  // Evidencia obligatoria
  url_foto_formulario String // URL en MinIO del formulario físico

  // Estado
  estado estado_salida_temporal @default(PROCESADA)

  // Observaciones
  observaciones String? @db.Text

  // Fechas
  fecha_salida               DateTime @default(now())
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  detalle salidas_temporales_ot_detalle[]

  @@index([codigo])
  @@index([id_bodega_origen])
  @@index([id_usuario_crea])
  @@index([estado])
  @@index([fecha_salida])
}

// Detalle de items en salida temporal
model salidas_temporales_ot_detalle {
  id_detalle         Int                   @id @default(autoincrement())
  id_salida_temporal Int
  salida_temporal    salidas_temporales_ot @relation(fields: [id_salida_temporal], references: [id_salida_temporal], onDelete: Cascade)

  // Producto
  id_catalogo Int
  catalogo    catalogo @relation(fields: [id_catalogo], references: [id_catalogo])

  // Cantidad (para productos no serializados)
  cantidad Int @default(1)

  // Serie (para productos serializados, opcional)
  id_serie Int?
  serie    inventario_series? @relation("salida_temporal_serie", fields: [id_serie], references: [id_serie])

  // Costo unitario al momento de la salida
  costo_unitario Decimal? @db.Decimal(10, 2)

  observaciones String?

  fecha_creacion DateTime @default(now())

  @@index([id_salida_temporal])
  @@index([id_catalogo])
  @@index([id_serie])
}

// ============= MÓDULO DE CONTRATOS DE CLIENTES =============

// Estados de contrato de cliente
enum estadoContrato {
  PENDIENTE_FIRMA       // Nuevo: Estado inicial - contrato creado, pendiente firma del cliente
  PENDIENTE_INSTALACION // Contrato firmado, pendiente instalacion del servicio
  INSTALADO_ACTIVO
  SUSPENDIDO
  SUSPENDIDO_TEMPORAL
  VELOCIDAD_REDUCIDA
  EN_MORA
  BAJA_DEFINITIVA
  BAJA_CAMBIO_TITULAR
  CANCELADO
}

// Catálogo: Tipos de Servicio (Residencial, Corporativo, Otro)
model atcTipoServicio {
  id_tipo_servicio Int      @id @default(autoincrement())
  nombre           String // "Residencial", "Corporativo", "Otro"
  codigo           String   @unique
  estado           estado   @default(ACTIVO)
  fecha_creacion   DateTime @default(now())

  // Relaciones
  tiposPlan atcTipoPlan[]
}

// Catálogo: Tipos de Plan (Internet Residencial, CATV Corporativo, etc.)
model atcTipoPlan {
  id_tipo_plan     Int             @id @default(autoincrement())
  nombre           String // "Internet Residencial"
  codigo           String          @unique // "IR"
  id_tipo_servicio Int
  tipoServicio     atcTipoServicio @relation(fields: [id_tipo_servicio], references: [id_tipo_servicio], onDelete: NoAction, onUpdate: NoAction, map: "fk_tipo_plan_tipo_servicio")
  estado           estado          @default(ACTIVO)
  fecha_creacion   DateTime        @default(now())

  // Relaciones
  planes atcPlan[]

  @@index([id_tipo_servicio])
}

// Catálogo: Planes de Servicio
model atcPlan {
  id_plan      Int         @id @default(autoincrement())
  nombre       String // "Plan 50 Mbps"
  descripcion  String?
  precio       Decimal     @db.Decimal(10, 2)
  id_tipo_plan Int
  tipoPlan     atcTipoPlan @relation(fields: [id_tipo_plan], references: [id_tipo_plan], onDelete: NoAction, onUpdate: NoAction, map: "fk_plan_tipo_plan")

  meses_contrato Int @default(12) // Duración del contrato

  // Datos técnicos de velocidad
  velocidad_bajada Int? // Mbps download
  velocidad_subida Int? // Mbps upload

  // Impuestos y cargos
  aplica_iva     Boolean @default(true)
  aplica_cesc    Boolean @default(false) // Contribución especial
  porcentaje_iva Decimal @default(13.00) @db.Decimal(5, 2)

  // Fechas de vigencia del plan
  fecha_inicio_vigencia DateTime?
  fecha_fin_vigencia    DateTime?

  estado              estado   @default(ACTIVO)
  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  contratos atcContrato[]

  @@index([id_tipo_plan])
  @@index([estado])
}

// Catálogo: Ciclos de Facturación
model atcCicloFacturacion {
  id_ciclo        Int      @id @default(autoincrement())
  nombre          String // "Ciclo 1 - día 3"
  dia_corte       Int // Día del mes para corte
  dia_vencimiento Int // Día del mes para vencimiento
  periodo_inicio  Int // Día inicio del período
  periodo_fin     Int // Día fin del período
  estado          estado   @default(ACTIVO)
  fecha_creacion  DateTime @default(now())

  // Relaciones
  contratos atcContrato[]
}

// Modelo Principal: Contrato de Cliente
model atcContrato {
  id_contrato Int    @id @default(autoincrement())
  codigo      String @unique // "CTR-YYYYMM-#####" formato automático

  // Cliente
  id_cliente Int
  cliente    cliente @relation(fields: [id_cliente], references: [id_cliente], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_cliente")

  // Plan contratado
  id_plan Int
  plan    atcPlan @relation(fields: [id_plan], references: [id_plan], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_plan")

  // Ciclo de facturación
  id_ciclo Int
  ciclo    atcCicloFacturacion @relation(fields: [id_ciclo], references: [id_ciclo], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_ciclo")

  // Dirección donde se presta el servicio
  id_direccion_servicio Int
  direccionServicio     clienteDirecciones @relation(fields: [id_direccion_servicio], references: [id_cliente_direccion], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_direccion")

  // Vinculación con Orden de Trabajo de Instalación
  id_orden_trabajo Int?
  ordenTrabajo     orden_trabajo? @relation(fields: [id_orden_trabajo], references: [id_orden], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_orden_trabajo")

  // Fechas del contrato
  fecha_venta           DateTime  @default(now())
  fecha_instalacion     DateTime?
  fecha_inicio_contrato DateTime?
  fecha_fin_contrato    DateTime?
  meses_contrato        Int       @default(12)

  // Costo de instalación
  costo_instalacion             Decimal?  @db.Decimal(10, 2)
  // true = factura separada de instalación, false = incluir en primera factura del servicio
  facturar_instalacion_separada Boolean   @default(true)

  // URL del contrato firmado (imagen/PDF almacenado en MinIO)
  url_contrato_firmado  String?   @db.Text

  // Estado del contrato
  estado estadoContrato @default(PENDIENTE_FIRMA)

  // === CONFIGURACIÓN DE MORA ESPECÍFICA DEL CONTRATO ===
  // Si es null, se usa la configuración por defecto de GeneralData
  id_mora_config Int?
  moraConfig     mora_configuracion? @relation("mora_contrato", fields: [id_mora_config], references: [id_mora_config], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_mora_config")

  // Auditoría
  id_usuario_creador Int
  usuarioCreador     usuarios @relation(fields: [id_usuario_creador], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_contrato_usuario_creador")

  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  // Relaciones
  instalacion  atcContratoInstalacion?
  dte_emitidos dte_emitidos[]

  @@index([id_cliente])
  @@index([id_plan])
  @@index([id_ciclo])
  @@index([estado])
  @@index([fecha_venta])
  @@index([id_orden_trabajo])
  @@index([id_mora_config])
}

// Datos técnicos de la instalación del contrato
model atcContratoInstalacion {
  id_instalacion Int         @id @default(autoincrement())
  id_contrato    Int         @unique
  contrato       atcContrato @relation(fields: [id_contrato], references: [id_contrato], onDelete: Cascade, onUpdate: NoAction, map: "fk_instalacion_contrato")

  // Datos WiFi
  wifi_nombre   String?
  wifi_password String?

  // Datos técnicos del equipo
  potencia_onu     String? // ej: "-18.5 dBm"
  mac_onu          String?
  numero_serie_onu String?

  // Estado de la instalación
  fecha_instalacion DateTime?
  instalado         Boolean   @default(false)
  observaciones     String?   @db.Text

  // Técnicos que realizaron la instalación (JSON array de IDs)
  tecnicos_instalacion String? @db.Text

  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  @@index([id_contrato])
}

// ============= FACTURACIÓN ELECTRÓNICA (DTE) =============

// Estado del ciclo de vida de un DTE emitido
enum estado_dte {
  BORRADOR // Creado pero no firmado/enviado
  FIRMADO // Firmado localmente, pendiente de transmisión
  TRANSMITIDO // Enviado a MH, esperando respuesta
  PROCESADO // Aceptado por MH con sello de recepción
  RECHAZADO // Rechazado por MH (errores de validación)
  CONTINGENCIA // Emitido en modo contingencia, pendiente de transmisión
  INVALIDADO // Anulado exitosamente ante MH
}

// Estado del proceso de invalidación/anulación
enum estado_anulacion {
  PENDIENTE // Solicitud creada, no enviada
  FIRMADA // Firmada localmente
  TRANSMITIDA // Enviada a MH
  PROCESADA // Aceptada por MH
  RECHAZADA // Rechazada por MH
}

// Tipo de invalidación según catálogo MH
enum tipo_invalidacion {
  ERROR_INFORMACION // Código 1: Error en información del DTE
  RESCINDIR_OPERACION // Código 2: Rescindir la operación
  OTRO // Código 3: Otro motivo
}

// Documento Tributario Electrónico emitido (Factura, CCF, etc.)
model dte_emitidos {
  id_dte Int @id @default(autoincrement())

  // === IDENTIFICACIÓN DEL DOCUMENTO ===
  codigo_generacion String   @unique @db.Char(36) // UUID v4 único del documento
  numero_control    String   @unique // DTE-XX-YYYYYYYY-ZZZZZZZZZZZZZZZ (31 chars)
  tipo_dte          String   @db.Char(2) // "01"=Factura, "03"=CCF, etc.
  version           Int      @default(1) // Versión del esquema JSON (1, 2, 3...)
  ambiente          String   @db.Char(2) // "00"=Pruebas, "01"=Producción
  tipo_modelo       Int      @default(1) // 1=Previo, 2=Diferido
  tipo_operacion    Int      @default(1) // 1=Normal, 2=Contingencia
  tipo_contingencia Int? // null si no es contingencia, código CAT005
  motivo_contin     String? // Motivo de contingencia (texto libre)

  // === FECHAS Y MONEDA ===
  fecha_emision DateTime @db.Date // Fecha de emisión del DTE
  hora_emision  String   @db.VarChar(8) // HH:MM:SS
  tipo_moneda   String   @default("USD") @db.VarChar(3)

  // === RECEPTOR (snapshot en momento de emisión) ===
  // Para Factura (01): receptor puede ser null/consumidor final
  // Para CCF (03): receptor obligatorio con NIT y NRC
  receptor_tipo_documento String? @db.VarChar(2) // Código tipo documento (36=NIT, 13=DUI, etc.)
  receptor_num_documento  String? @db.VarChar(20) // NIT, DUI, Pasaporte, etc.
  receptor_nrc            String? @db.VarChar(10) // NRC (solo CCF)
  receptor_nombre         String? @db.VarChar(250) // Nombre o razón social
  receptor_nombre_comerc  String? @db.VarChar(250) // Nombre comercial
  receptor_cod_actividad  String? @db.VarChar(10) // Código actividad económica
  receptor_desc_actividad String? @db.VarChar(250) // Descripción actividad
  receptor_telefono       String? @db.VarChar(30)
  receptor_correo         String? @db.VarChar(100)
  // Dirección del receptor
  receptor_departamento   String? @db.VarChar(2) // Código departamento MH
  receptor_municipio      String? @db.VarChar(2) // Código municipio MH
  receptor_complemento    String? @db.VarChar(200) // Dirección completa

  // === RELACIÓN CON CLIENTE (opcional, para trazabilidad) ===
  id_cliente               Int?
  cliente                  cliente?                  @relation(fields: [id_cliente], references: [id_cliente], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_cliente")
  id_cliente_facturacion   Int?
  clienteDatosFacturacion  clienteDatosFacturacion?  @relation(fields: [id_cliente_facturacion], references: [id_cliente_datos_facturacion], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_cliente_facturacion")

  // === RELACIÓN CON CONTRATO (facturación recurrente) ===
  id_contrato Int?
  contrato    atcContrato? @relation(fields: [id_contrato], references: [id_contrato], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_contrato")

  // === SUCURSAL / PUNTO DE VENTA ===
  id_sucursal Int?
  sucursal    sucursales? @relation(fields: [id_sucursal], references: [id_sucursal], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_sucursal")

  // === TOTALES DEL RESUMEN ===
  total_no_sujetas       Decimal @default(0) @db.Decimal(12, 2)
  total_exentas          Decimal @default(0) @db.Decimal(12, 2)
  total_gravadas         Decimal @default(0) @db.Decimal(12, 2)
  subtotal_ventas        Decimal @default(0) @db.Decimal(12, 2) // noSuj + exentas + gravadas
  descuento_no_sujetas   Decimal @default(0) @db.Decimal(12, 2)
  descuento_exentas      Decimal @default(0) @db.Decimal(12, 2)
  descuento_gravadas     Decimal @default(0) @db.Decimal(12, 2)
  porcentaje_descuento   Decimal @default(0) @db.Decimal(5, 2) // 0.00 a 100.00
  total_descuentos       Decimal @default(0) @db.Decimal(12, 2)
  subtotal               Decimal @default(0) @db.Decimal(12, 2) // subtotalVentas - descuentos
  // Campos específicos de CCF
  iva_perci1             Decimal @default(0) @db.Decimal(12, 2) // IVA percibido
  iva_rete1              Decimal @default(0) @db.Decimal(12, 2) // IVA retenido
  rete_renta             Decimal @default(0) @db.Decimal(12, 2) // Retención renta
  // Campos específicos de Factura (consumidor)
  total_iva              Decimal @default(0) @db.Decimal(12, 2) // IVA incluido (solo FC)
  // Totales finales
  monto_total_operacion  Decimal @default(0) @db.Decimal(12, 2)
  total_no_gravado       Decimal @default(0) @db.Decimal(12, 2)
  total_pagar            Decimal @default(0) @db.Decimal(12, 2)
  total_letras           String  @db.VarChar(300) // "MIL DOSCIENTOS DÓLARES"
  saldo_favor            Decimal @default(0) @db.Decimal(12, 2)

  // === CONDICIÓN DE OPERACIÓN Y PAGOS ===
  condicion_operacion Int     @default(1) // 1=Contado, 2=Crédito, 3=Otro
  pagos_json          String? @db.Text // JSON array de formas de pago [{codigo, monto, plazo, periodo}]
  num_pago_electronico String? @db.VarChar(100) // Número de referencia pago electrónico

  // === DOCUMENTOS RELACIONADOS (para NC, ND) ===
  documentos_relacionados_json String? @db.Text // JSON array de documentos relacionados

  // === OTROS CAMPOS OPCIONALES ===
  otros_documentos_json String? @db.Text // JSON de otrosDocumentos
  venta_tercero_json    String? @db.Text // JSON de ventaTercero
  extension_json        String? @db.Text // JSON de extensión
  apendice_json         String? @db.Text // JSON de apéndice

  // === TRIBUTOS ===
  tributos_json String? @db.Text // JSON array de tributos del resumen

  // === JSON COMPLETO DEL DTE ===
  dte_json     String @db.Text // JSON completo del DTE (para referencia/auditoría)
  dte_firmado  String? @db.Text // DTE firmado (JWS) listo para transmitir

  // === RESPUESTA DE HACIENDA ===
  sello_recepcion   String?   @db.VarChar(50) // Sello de 40 chars que otorga MH
  fecha_recepcion   DateTime? // fhProcesamiento de MH
  codigo_msg        String?   @db.VarChar(10) // Código de mensaje de respuesta
  descripcion_msg   String?   @db.VarChar(500) // Mensaje de MH
  observaciones_mh  String?   @db.Text // Observaciones adicionales de MH

  // === ESTADO Y WORKFLOW ===
  estado              estado_dte @default(BORRADOR)
  intentos_transmision Int       @default(0)
  ultimo_error        String?    @db.Text // Último error de transmisión

  // === AUDITORÍA ===
  id_usuario_crea Int
  usuarioCrea     usuarios @relation("dte_usuario_crea", fields: [id_usuario_crea], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_usuario_crea")

  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  // === RELACIONES ===
  detalle     dte_emitidos_detalle[]
  anulaciones dte_anulaciones[]

  // === ÍNDICES ===
  @@index([tipo_dte])
  @@index([estado])
  @@index([fecha_emision])
  @@index([id_cliente])
  @@index([id_contrato])
  @@index([id_sucursal])
  @@index([receptor_num_documento])
  @@index([sello_recepcion])
}

// Detalle de líneas del DTE (cuerpoDocumento)
model dte_emitidos_detalle {
  id_detalle Int @id @default(autoincrement())

  // Relación con DTE padre
  id_dte Int
  dte    dte_emitidos @relation(fields: [id_dte], references: [id_dte], onDelete: Cascade, onUpdate: NoAction, map: "fk_dte_detalle_dte")

  // === DATOS DEL ÍTEM ===
  num_item          Int // Número de línea (1, 2, 3...)
  tipo_item         Int // 1=Bienes, 2=Servicios, 3=Ambos, 4=Tributo
  numero_documento  String? @db.VarChar(50) // Documento relacionado (para NRE)
  codigo            String? @db.VarChar(50) // SKU/Código del producto
  cod_tributo       String? @db.VarChar(10) // Código de tributo (si tipo_item=4)
  descripcion       String  @db.VarChar(1000)
  cantidad          Decimal @db.Decimal(12, 4)
  uni_medida        Int // Código unidad de medida (1=Unidad, 59=Servicio, etc.)
  precio_unitario   Decimal @db.Decimal(12, 4)
  monto_descuento   Decimal @default(0) @db.Decimal(12, 2)

  // === VENTAS POR TIPO ===
  venta_no_sujeta Decimal @default(0) @db.Decimal(12, 2)
  venta_exenta    Decimal @default(0) @db.Decimal(12, 2)
  venta_gravada   Decimal @default(0) @db.Decimal(12, 2)

  // === TRIBUTOS DEL ÍTEM ===
  tributos_json String? @db.Text // JSON array de tributos del ítem

  // === IVA POR ÍTEM (solo Factura consumidor tipo 01) ===
  iva_item Decimal @default(0) @db.Decimal(12, 2)

  // === OTROS CAMPOS ===
  psv        Decimal @default(0) @db.Decimal(12, 2) // Precio sugerido de venta
  no_gravado Decimal @default(0) @db.Decimal(12, 2) // Cargos que no afectan base imponible

  // === RELACIÓN OPCIONAL CON CATÁLOGO ===
  id_catalogo Int?
  catalogo    catalogo? @relation(fields: [id_catalogo], references: [id_catalogo], onDelete: NoAction, onUpdate: NoAction, map: "fk_dte_detalle_catalogo")

  fecha_creacion DateTime @default(now())

  @@index([id_dte])
  @@index([id_catalogo])
}

// Registro de invalidaciones/anulaciones de DTE
model dte_anulaciones {
  id_anulacion Int @id @default(autoincrement())

  // Relación con DTE original
  id_dte Int
  dte    dte_emitidos @relation(fields: [id_dte], references: [id_dte], onDelete: NoAction, onUpdate: NoAction, map: "fk_anulacion_dte")

  // === IDENTIFICACIÓN DEL EVENTO ===
  codigo_generacion String @unique @db.Char(36) // UUID v4 del evento de anulación
  version           Int    @default(2)
  ambiente          String @db.Char(2) // "00" o "01"

  // === MOTIVO DE INVALIDACIÓN ===
  tipo_invalidacion      tipo_invalidacion // ERROR_INFORMACION, RESCINDIR_OPERACION, OTRO
  motivo_invalidacion    String? @db.VarChar(250) // Descripción del motivo
  nombre_responsable     String  @db.VarChar(200) // Quien solicita la anulación
  tipo_doc_responsable   String  @db.VarChar(2) // Tipo doc de quien solicita
  num_doc_responsable    String  @db.VarChar(25) // Número doc de quien solicita
  nombre_solicita        String  @db.VarChar(200) // Nombre de quien solicita (puede ser receptor)
  tipo_doc_solicita      String  @db.VarChar(2) // Tipo doc de quien solicita
  num_doc_solicita       String  @db.VarChar(25) // Número doc de quien solicita

  // === DOCUMENTO ORIGINAL (snapshot) ===
  tipo_documento_original       String   @db.VarChar(2) // Tipo del DTE que se anula
  numero_documento_original     String   @db.VarChar(36) // codigoGeneracion del DTE original
  fecha_emision_original        DateTime @db.Date
  monto_iva_original            Decimal  @db.Decimal(12, 2)
  codigo_generacion_reemplazo   String?  @db.Char(36) // UUID del DTE de reemplazo (si aplica)

  // === JSON Y FIRMA ===
  anulacion_json   String  @db.Text // JSON completo del evento de invalidación
  anulacion_firmada String? @db.Text // Evento firmado (JWS)

  // === RESPUESTA DE HACIENDA ===
  sello_recepcion  String?   @db.VarChar(50)
  fecha_recepcion  DateTime?
  codigo_msg       String?   @db.VarChar(10)
  descripcion_msg  String?   @db.VarChar(500)

  // === ESTADO ===
  estado              estado_anulacion @default(PENDIENTE)
  intentos_transmision Int              @default(0)
  ultimo_error        String?          @db.Text

  // === AUDITORÍA ===
  id_usuario_crea Int
  usuarioCrea     usuarios @relation("anulacion_usuario_crea", fields: [id_usuario_crea], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction, map: "fk_anulacion_usuario_crea")

  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  @@index([id_dte])
  @@index([estado])
  @@index([fecha_creacion])
}

// ============= CONFIGURACIÓN DE MORA =============

// Tipo de cálculo para la mora
enum tipo_calculo_mora {
  MONTO_FIJO // Monto fijo en USD (ej: $5.00)
  PORCENTAJE_SALDO // Porcentaje sobre saldo pendiente actual
  PORCENTAJE_MONTO_ORIGINAL // Porcentaje sobre monto original de la factura
}

// Frecuencia de aplicación de la mora
enum frecuencia_mora {
  UNICA // Se aplica una sola vez al vencer
  DIARIA // Se aplica cada día de atraso
  SEMANAL // Se aplica cada semana de atraso
  MENSUAL // Se aplica cada mes de atraso
}

// Configuración de políticas de mora reutilizables
model mora_configuracion {
  id_mora_config Int @id @default(autoincrement())

  // === IDENTIFICACIÓN ===
  codigo String @unique // "MORA_ESTANDAR", "MORA_CORPORATIVA", "SIN_MORA"
  nombre String // "Mora Estándar Residencial"
  descripcion String? @db.Text

  // === PARÁMETROS DE CÁLCULO ===
  tipo_calculo tipo_calculo_mora @default(MONTO_FIJO)
  valor        Decimal           @db.Decimal(10, 4) // Monto ($) o porcentaje (%) según tipo_calculo

  // === DÍAS DE GRACIA ===
  dias_gracia Int @default(0) // Días después de vencimiento antes de aplicar mora

  // === LÍMITES Y TOPES ===
  mora_maxima        Decimal? @db.Decimal(10, 2) // Tope máximo de mora acumulada (null = sin tope)
  porcentaje_maximo  Decimal? @db.Decimal(5, 2) // % máximo sobre monto original (null = sin tope)

  // === FRECUENCIA Y ACUMULACIÓN ===
  frecuencia       frecuencia_mora @default(UNICA)
  es_acumulativa   Boolean         @default(false) // true = mora sobre mora, false = solo sobre saldo original

  // === CONTROL ===
  activo                     Boolean  @default(true)
  fecha_creacion             DateTime @default(now())
  fecha_ultima_actualizacion DateTime @default(now()) @updatedAt

  // === RELACIONES INVERSAS ===
  general_data_default GeneralData[] @relation("mora_default")
  contratos            atcContrato[] @relation("mora_contrato")

  @@index([codigo])
  @@index([activo])
}

// ============= CATÁLOGOS DE CLIENTE =============

model cat_estado_civil {
  id_estado_civil            Int       @id @default(autoincrement())
  codigo                     String    @unique
  nombre                     String
  activo                     Boolean   @default(true)
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt
  clientes                   cliente[]
}

model cat_estado_vivienda {
  id_estado_vivienda         Int       @id @default(autoincrement())
  codigo                     String    @unique
  nombre                     String
  activo                     Boolean   @default(true)
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt
  clientes                   cliente[]
}

// ============= MÓDULO WHATSAPP CHAT =============

// Estados de conversación WhatsApp
enum estado_chat {
  ABIERTO
  PENDIENTE
  CERRADO
  IA_MANEJANDO
}

// Dirección del mensaje
enum direccion_mensaje {
  ENTRANTE
  SALIENTE
}

// Tipo de mensaje WhatsApp
enum tipo_mensaje_whatsapp {
  TEXTO
  IMAGEN
  VIDEO
  AUDIO
  DOCUMENTO
  UBICACION
  CONTACTO
  STICKER
  PLANTILLA
}

// Estado de envío del mensaje
enum estado_mensaje_whatsapp {
  PENDIENTE
  ENVIADO
  ENTREGADO
  LEIDO
  FALLIDO
}

// Proveedor de IA
enum proveedor_ia {
  OPENAI
  CLAUDE
  CUSTOM
}

// Lógica de condiciones en reglas
enum logica_condicion {
  AND
  OR
}

// Conversación de WhatsApp
model whatsapp_chat {
  id_chat                    Int       @id @default(autoincrement())
  whatsapp_chat_id           String    @unique // ID externo de WhatsApp
  id_cliente                 Int?
  telefono_cliente           String
  nombre_cliente             String?
  foto_perfil_cliente        String?   @db.Text
  estado                     estado_chat @default(PENDIENTE)
  id_usuario_asignado        Int?
  ultimo_mensaje_at          DateTime?
  preview_ultimo_mensaje     String?   @db.Text
  mensajes_no_leidos         Int       @default(0)
  ia_habilitada              Boolean   @default(true)
  ia_mensajes_count          Int       @default(0)
  tags                       String[]
  metadata                   Json?
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt
  fecha_cierre               DateTime?

  // Relaciones
  cliente                    cliente?  @relation(fields: [id_cliente], references: [id_cliente], onDelete: SetNull, onUpdate: NoAction, map: "fk_whatsapp_chat_cliente")
  usuario_asignado           usuarios? @relation("whatsapp_chat_asignado", fields: [id_usuario_asignado], references: [id_usuario], onDelete: SetNull, onUpdate: NoAction, map: "fk_whatsapp_chat_usuario_asignado")
  mensajes                   whatsapp_message[]
  asignaciones               whatsapp_chat_assignment[]
  metricas                   whatsapp_chat_metrics?

  @@index([id_cliente])
  @@index([id_usuario_asignado])
  @@index([estado])
  @@index([telefono_cliente])
  @@index([ultimo_mensaje_at])
}

// Mensaje de WhatsApp
model whatsapp_message {
  id_message                 Int       @id @default(autoincrement())
  id_chat                    Int
  whatsapp_message_id        String    @unique // ID externo de WhatsApp
  direccion                  direccion_mensaje
  tipo                       tipo_mensaje_whatsapp @default(TEXTO)
  contenido                  String    @db.Text
  url_media                  String?   @db.Text
  tipo_media                 String?
  tamano_media               Int?
  estado                     estado_mensaje_whatsapp @default(ENVIADO)
  id_usuario_envia           Int?      // Si es saliente, quién lo envió
  es_de_ia                   Boolean   @default(false)
  id_regla_ia                Int?
  confianza_ia               Float?
  metadata                   Json?
  fecha_creacion             DateTime  @default(now())
  fecha_entrega              DateTime?
  fecha_lectura              DateTime?

  // Relaciones
  chat                       whatsapp_chat @relation(fields: [id_chat], references: [id_chat], onDelete: Cascade, onUpdate: NoAction, map: "fk_whatsapp_message_chat")
  usuario_envia              usuarios?     @relation("whatsapp_message_usuario", fields: [id_usuario_envia], references: [id_usuario], onDelete: SetNull, onUpdate: NoAction, map: "fk_whatsapp_message_usuario")
  regla_ia                   whatsapp_ia_rule? @relation(fields: [id_regla_ia], references: [id_regla], onDelete: SetNull, onUpdate: NoAction, map: "fk_whatsapp_message_regla_ia")

  @@index([id_chat])
  @@index([id_usuario_envia])
  @@index([direccion])
  @@index([fecha_creacion])
}

// Configuración de IA para WhatsApp
model whatsapp_ia_config {
  id_config                  Int       @id @default(autoincrement())
  nombre                     String
  descripcion                String?   @db.Text
  activo                     Boolean   @default(false)
  proveedor                  proveedor_ia @default(OPENAI)
  modelo                     String    @default("gpt-4")
  api_key                    String?   @db.Text // Encriptado, null si usa key global
  temperatura                Float     @default(0.7)
  max_tokens                 Int       @default(500)
  system_prompt              String    @db.Text
  ventana_contexto           Int       @default(10) // Número de mensajes previos a incluir
  fallback_a_humano          Boolean   @default(true)
  condiciones_fallback       Json?     // Array de FallbackCondition
  delay_respuesta_seg        Int       @default(2)
  horario_atencion           Json?     // BusinessHours config
  metadata                   Json?
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  // Relaciones
  reglas                     whatsapp_ia_rule[]

  @@index([activo])
}

// Reglas de IA para respuestas automáticas
model whatsapp_ia_rule {
  id_regla                   Int       @id @default(autoincrement())
  id_config                  Int
  nombre                     String
  descripcion                String?   @db.Text
  prioridad                  Int       @default(0) // Mayor = más prioridad
  activo                     Boolean   @default(true)
  condiciones                Json      // Array de RuleCondition
  logica_condiciones         logica_condicion @default(AND)
  acciones                   Json      // Array de RuleAction
  metadata                   Json?
  ejecuciones_count          Int       @default(0)
  ultima_ejecucion_at        DateTime?
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  // Relaciones
  config                     whatsapp_ia_config @relation(fields: [id_config], references: [id_config], onDelete: Cascade, onUpdate: NoAction, map: "fk_whatsapp_ia_rule_config")
  mensajes                   whatsapp_message[]

  @@index([id_config])
  @@index([activo])
  @@index([prioridad])
}

// Historial de asignaciones de chat
model whatsapp_chat_assignment {
  id_asignacion              Int       @id @default(autoincrement())
  id_chat                    Int
  id_usuario                 Int
  id_asignado_por            Int?
  fecha_asignacion           DateTime  @default(now())
  fecha_desasignacion        DateTime?
  razon                      String?   @db.Text
  activo                     Boolean   @default(true)

  // Relaciones
  chat                       whatsapp_chat @relation(fields: [id_chat], references: [id_chat], onDelete: Cascade, onUpdate: NoAction, map: "fk_whatsapp_assignment_chat")
  usuario                    usuarios      @relation("whatsapp_assignment_usuario", fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction, map: "fk_whatsapp_assignment_usuario")
  asignado_por               usuarios?     @relation("whatsapp_assignment_asignado_por", fields: [id_asignado_por], references: [id_usuario], onDelete: SetNull, onUpdate: NoAction, map: "fk_whatsapp_assignment_asignado_por")

  @@index([id_chat])
  @@index([id_usuario])
  @@index([activo])
}

// Métricas de chat
model whatsapp_chat_metrics {
  id_metrica                 Int       @id @default(autoincrement())
  id_chat                    Int       @unique
  tiempo_primera_respuesta   Int?      // Segundos
  tiempo_respuesta_promedio  Int?
  total_mensajes             Int       @default(0)
  mensajes_agente            Int       @default(0)
  mensajes_ia                Int       @default(0)
  mensajes_cliente           Int       @default(0)
  duracion                   Int?      // Segundos desde apertura a cierre
  puntuacion_satisfaccion    Int?      // 1-5
  fue_escalado               Boolean   @default(false)
  razon_escalado             String?   @db.Text
  fecha_creacion             DateTime  @default(now())
  fecha_ultima_actualizacion DateTime  @default(now()) @updatedAt

  // Relaciones
  chat                       whatsapp_chat @relation(fields: [id_chat], references: [id_chat], onDelete: Cascade, onUpdate: NoAction, map: "fk_whatsapp_metrics_chat")

  @@index([id_chat])
}
